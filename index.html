<!-- WISEFOX LEADAPP â€” UPDATED UI + FIXED LEAD SAVE + SEPARATE PAGES -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wisefox LeadApp</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-md mx-auto bg-white min-h-screen shadow p-4">

<h2 class="font-bold text-lg mb-3">Wisefox LeadApp</h2>

<!-- LOGIN -->
<div id="authBox" class="space-y-2">
<button onclick="googleLogin()" class="w-full bg-red-500 text-white p-2 rounded">Login with Google</button>
</div>

<!-- SIGNUP -->
<div id="signupBox" class="hidden space-y-2 mt-3">
<input id="mobile" placeholder="Mobile Number" class="w-full border p-2" />
<input id="location" placeholder="Location" class="w-full border p-2" />
<button onclick="completeSignup()" class="w-full bg-indigo-600 text-white p-2">Complete Signup</button>
</div>

<!-- MAIN APP -->
<div id="app" class="hidden">

<!-- TOP NAV -->
<div class="flex gap-2 mb-3">
<button onclick="showPage('leads')" class="bg-indigo-600 text-white px-3 py-1 rounded">Leads</button>
<button onclick="showPage('users')" class="bg-gray-300 px-3 py-1 rounded">Users</button>
<button onclick="logout()" class="ml-auto bg-gray-200 px-3 py-1 rounded">Logout</button>
</div>

<!-- LEADS PAGE -->
<div id="leadsPage">
<button onclick="openModal()" class="w-full bg-indigo-600 text-white py-2 rounded mb-3">+ Generate Lead</button>
<div id="list" class="space-y-2"></div>

<!-- STATUS UPDATE MODAL -->
<div id="statusModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
<div class="bg-white p-4 rounded w-80">
<h3 class="font-bold mb-2">Update Status</h3>
<select id="newStatus" class="w-full border p-2 mb-2">
<option>Pending</option>
<option>Contacted</option>
<option>In Process</option>
<option>Sanctioned</option>
<option>Disbursed</option>
<option>Rejected</option>
</select>
<button onclick="saveStatus()" class="w-full bg-indigo-600 text-white p-2 mb-1">Update</button>
<button onclick="closeStatusModal()" class="w-full text-gray-500">Cancel</button>
</div>
</div>
</div>

<!-- USERS PAGE -->
<div id="usersPage" class="hidden">
<div id="dsaPanel" class="hidden mb-3">
<h3 class="font-bold">Create Subâ€‘DSA</h3>
<input id="subEmail" placeholder="User Email" class="w-full border p-2 mb-1" />
<input id="subMobile" placeholder="Mobile" class="w-full border p-2 mb-1" />
<button onclick="createSubDSA()" class="w-full bg-blue-600 text-white p-2">Create Subâ€‘DSA</button>
</div>

<div id="mySubList" class="hidden">
<h3 class="font-bold mb-2">My Subâ€‘DSA Team</h3>
<div id="subList" class="space-y-2"></div>
</div>

<div id="adminPanel" class="hidden">
<h3 class="font-bold mb-2">All Users</h3>
<label class="text-sm">Select Parent DSA (for SubDSA)</label>
<select id="parentDSASelect" class="w-full border p-2 mb-2"></select>
<h3 class="font-bold mb-2">All Users</h3>
<div id="userList" class="space-y-2"></div>
</div>
</div>
</div>
</div>

<!-- ADD LEAD MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
<div class="bg-white p-4 rounded w-80">
<h3 class="font-bold mb-2">Generate Lead</h3>
<input id="leadName" placeholder="Client Name" class="w-full border p-2 mb-2" />
<input id="leadPhone" placeholder="Mobile" class="w-full border p-2 mb-2" />
<select id="type" class="w-full border p-2 mb-2">
<option>Personal Loan</option>
<option>Home Loan</option>
<option>Business Loan</option>
<option>Auto Loan</option>
</select>
<input id="leadAmount" placeholder="Amount" class="w-full border p-2 mb-2" />
<button onclick="saveLead()" class="w-full bg-indigo-600 text-white p-2 mb-1">Save Lead</button>
<button onclick="closeModal()" class="w-full text-gray-500">Cancel</button>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E",
authDomain: "wisfox-lead-app.firebaseapp.com",
projectId: "wisfox-lead-app"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);
const provider = new GoogleAuthProvider();

let currentUser = null;

// LOGIN
window.googleLogin = async () => {
try {
const result = await signInWithPopup(auth, provider);
handleLogin(result.user);
} catch {
await signInWithRedirect(auth, provider);
}
};

async function handleLogin(user){
const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
if(snap.empty){
authBox.classList.add('hidden');
signupBox.classList.remove('hidden');
window.tempUser=user;return;
}
currentUser=snap.docs[0].data();
startApp();
}

// SIGNUP
window.completeSignup = async () => {
const user=window.tempUser;
const mobileVal=(mobile.value||'').trim();
const locationVal=(location.value||'').trim();
if(!mobileVal||!locationVal) return alert('Enter full details');
const role=user.email==='nil000nilesh@gmail.com'?'admin':'new';
await setDoc(doc(db,'users',user.uid),{name:user.displayName,email:user.email,mobile:mobileVal,location:locationVal,role,parentEmail:null});
currentUser={name:user.displayName,email:user.email,role};
signupBox.classList.add('hidden');
startApp();
};

function startApp(){
// ---- HIDE LOGIN BUTTON AFTER LOGIN ----
document.getElementById('authBox').classList.add('hidden');

document.getElementById('app').classList.remove('hidden');
loadLeads();

// ---- ADMIN POWERS ----
if(currentUser.role==='admin'){
  document.getElementById('adminPanel').classList.remove('hidden');
  loadNewUsers();
}

// ---- DSA CAN SEE USERS ONLY AFTER ADMIN LINKS SUBDSA ----


if(currentUser.role==='dsa'){
  document.getElementById('dsaPanel').classList.remove('hidden');
  document.getElementById('mySubList').classList.remove('hidden');
  loadMySubDSA();
}
}

window.logout=()=>signOut(auth).then(()=>location.reload());

// PAGE SWITCH
window.showPage=(p)=>{
leadsPage.classList.toggle('hidden',p!=='leads');
usersPage.classList.toggle('hidden',p!=='users');
};

// LOAD LEADS
function loadLeads(){
onSnapshot(collection(db,'leads'),snap=>{
list.innerHTML='';
snap.forEach(d=>{
const l=d.data();
if(currentUser.role==='subdsa'&&l.agentEmail!==currentUser.email)return;
let btn='';
if(currentUser.role==='dsa' || currentUser.role==='admin'){
btn=`<button onclick="openStatusModal('${d.id}','${l.status||'Pending'}')" class='text-xs bg-indigo-100 px-2 mt-1'>Update Status</button>`;
}
let adminBtns='';
if(currentUser.role==='admin'){
adminBtns=`<button onclick="deleteLead('${d.id}')" class='text-xs bg-red-200 px-2 ml-1'>Delete</button>`;
}
list.innerHTML+=`<div class='border p-2 rounded'><b>${l.name}</b><br>${l.type} | â‚¹${l.amount}<br>ðŸ“± ${l.phone}<br>Status: <b>${l.status||'Pending'}</b><br>${btn} ${adminBtns}</div>`;
});
});}

// SAVE LEAD (FIXED)
window.saveLead=async()=>{
try{
const nameVal=(document.getElementById('leadName').value||'').trim();
const phoneVal=(document.getElementById('leadPhone').value||'').trim();
const amountVal=(document.getElementById('leadAmount').value||'').trim();
const typeVal=(document.getElementById('type').value||'Auto Loan');

if(!nameVal||!phoneVal||!amountVal){
alert('Fill all fields');
return;
}

// BLOCK CHECK
const userSnap=await getDocs(query(collection(db,'users'),where('email','==',currentUser.email)));
if(!userSnap.empty && userSnap.docs[0].data().blocked){
alert('You are blocked by Admin. Cannot add lead');
return;
}

await addDoc(collection(db,'leads'),{
name:nameVal,
phone:phoneVal,
type:typeVal,
amount:Number(amountVal)||0,
status:'Pending',
agentEmail:currentUser.email||'',
created:new Date()
});

// UI RESET
closeModal();
document.getElementById('leadName').value='';
document.getElementById('leadPhone').value='';
document.getElementById('leadAmount').value='';

alert('Lead Saved Successfully');

}catch(err){
console.error('Lead Save Error:',err);
alert('Lead save failed â€” check console');
}
};

window.openModal=()=>modal.classList.remove('hidden');

// STATUS MODAL
let currentLeadId=null;
window.openStatusModal=(id,status)=>{
currentLeadId=id;
document.getElementById('newStatus').value=status||'Pending';
document.getElementById('statusModal').classList.remove('hidden');
};
window.closeStatusModal=()=>document.getElementById('statusModal').classList.add('hidden');
window.saveStatus=async()=>{
if(!currentLeadId)return;
const s=document.getElementById('newStatus').value;
await updateDoc(doc(db,'leads',currentLeadId),{status:s});
closeStatusModal();
};
window.closeModal=()=>modal.classList.add('hidden');

// ADMIN USERS
function loadNewUsers(){
// ---- LOAD DSA DROPDOWN ----
const dsaQuery=query(collection(db,'users'),where('role','==','dsa'));
onSnapshot(dsaQuery,snap=>{
const sel=document.getElementById('parentDSASelect');
if(!sel) return;
sel.innerHTML='<option value="">Select DSA</option>';
snap.forEach(d=>{
const u=d.data();
sel.innerHTML+=`<option value="${u.email}">${u.name||u.email}</option>`;
});
});

// ---- LOAD ALL USERS LIST ----
onSnapshot(collection(db,'users'),snap=>{
userList.innerHTML='';
snap.forEach(d=>{
const u=d.data();
let roleBtn='';

if(u.role!=='dsa') roleBtn+=`<button onclick="setRole('${d.id}','dsa')" class='text-xs bg-green-200 px-2 mr-1'>Make DSA</button>`;
roleBtn+=`<button onclick="makeSubDSA('${d.id}')" class='text-xs bg-blue-200 px-2'>Make SubDSA</button>`;

let blockBtn='';
let deleteUserBtn='';
if(currentUser.role==='admin'){
blockBtn=`<button onclick="toggleBlock('${d.id}','${u.blocked?'yes':'no'}')" class='text-xs bg-yellow-200 px-2 mr-1'>${u.blocked?'Unblock':'Block'}</button>`;
deleteUserBtn=`<button onclick="deleteUser('${d.id}')" class='text-xs bg-red-200 px-2'>Delete</button>`;
}
userList.innerHTML+=`<div class='border p-2 rounded'>
<b>${u.name||''}</b><br>${u.email||''}<br>Role: ${u.role||'new'}<br>${roleBtn} ${blockBtn} ${deleteUserBtn}
</div>`;
});
});
}

// ADMIN DELETE USER
window.deleteUser=async(id)=>{
if(currentUser.role!=='admin') return;
if(!confirm('Delete this user?')) return;
await deleteDoc(doc(db,'users',id));
};

// ADMIN BLOCK / UNBLOCK USER
window.toggleBlock=async(id,state)=>{
if(currentUser.role!=='admin') return;
const blocked=(state!=='yes');
await updateDoc(doc(db,'users',id),{blocked});
};

window.makeSubDSA=async(id)=>{
const parent=document.getElementById('parentDSASelect').value;
if(!parent){
alert('Select Parent DSA');
return;
}
await updateDoc(doc(db,'users',id),{role:'subdsa',parentEmail:parent});
alert('SubDSA linked under selected DSA');
};

window.setRole=async(id,role)=>updateDoc(doc(db,'users',id),{role});

// ADMIN DELETE LEAD
window.deleteLead=async(id)=>{
if(currentUser.role!=='admin') return;
if(!confirm('Delete this lead?')) return;
await deleteDoc(doc(db,'leads',id));
};

// DSA SUBDSA
window.createSubDSA=async()=>{
const email=subEmail.value.trim();
const snap=await getDocs(query(collection(db,'users'),where('email','==',email)));
if(snap.empty)return alert('User not found');
const docSnap=snap.docs[0];
if(docSnap.data().role!=='new')return alert('User already engaged');
await updateDoc(doc(db,'users',docSnap.id),{role:'subdsa',parentEmail:currentUser.email});
alert('SubDSA created');
};

function loadMySubDSA(){
const q=query(collection(db,'users'),where('parentEmail','==',currentUser.email));
onSnapshot(q,snap=>{subList.innerHTML='';snap.forEach(d=>{const u=d.data();subList.innerHTML+=`<div class='border p-2 rounded bg-blue-50'><b>${u.name}</b><br>${u.email}<br>${u.mobile}</div>`;});});}

</script>
</body>
</html>
