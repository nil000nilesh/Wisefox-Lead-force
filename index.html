<!-- WISEFOX LEADAPP â€” UPDATED UI + FIXED LEAD SAVE + SEPARATE PAGES -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wisefox LeadApp</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-md mx-auto bg-white min-h-screen shadow p-4">

<h2 class="font-bold text-lg mb-3">Wisefox LeadApp</h2>

<!-- LOGIN -->
<div id="authBox" class="space-y-2">
<button onclick="googleLogin()" class="w-full bg-red-500 text-white p-2 rounded">Login with Google</button>
</div>

<!-- SIGNUP -->
<div id="signupBox" class="hidden space-y-2 mt-3">
<input id="mobile" placeholder="Mobile Number" class="w-full border p-2" />
<input id="location" placeholder="Location" class="w-full border p-2" />
<button onclick="completeSignup()" class="w-full bg-indigo-600 text-white p-2">Complete Signup</button>
</div>

<!-- MAIN APP -->
<div id="app" class="hidden">

<!-- TOP NAV -->
<div class="flex gap-2 mb-3">
<button onclick="showPage('leads')" class="bg-indigo-600 text-white px-3 py-1 rounded">Leads</button>
<button onclick="showPage('users')" class="bg-gray-300 px-3 py-1 rounded">Users</button>
<button onclick="logout()" class="ml-auto bg-gray-200 px-3 py-1 rounded">Logout</button>
</div>

<!-- LEADS PAGE -->
<div id="leadsPage">
<button onclick="openModal()" class="w-full bg-indigo-600 text-white py-2 rounded mb-3">+ Generate Lead</button>
<div id="list" class="space-y-2"></div>
</div>

<!-- USERS PAGE -->
<div id="usersPage" class="hidden">
<div id="dsaPanel" class="hidden mb-3">
<h3 class="font-bold">Create Subâ€‘DSA</h3>
<input id="subEmail" placeholder="User Email" class="w-full border p-2 mb-1" />
<input id="subMobile" placeholder="Mobile" class="w-full border p-2 mb-1" />
<button onclick="createSubDSA()" class="w-full bg-blue-600 text-white p-2">Create Subâ€‘DSA</button>
</div>

<div id="mySubList" class="hidden">
<h3 class="font-bold mb-2">My Subâ€‘DSA Team</h3>
<div id="subList" class="space-y-2"></div>
</div>

<div id="adminPanel" class="hidden">
<h3 class="font-bold mb-2">New Users</h3>
<div id="userList" class="space-y-2"></div>
</div>
</div>
</div>

<!-- ADD LEAD MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
<div class="bg-white p-4 rounded w-80">
<h3 class="font-bold mb-2">Generate Lead</h3>
<input id="name" placeholder="Client Name" class="w-full border p-2 mb-2" />
<input id="phone" placeholder="Mobile" class="w-full border p-2 mb-2" />
<select id="type" class="w-full border p-2 mb-2">
<option>Personal Loan</option>
<option>Home Loan</option>
<option>Business Loan</option>
<option>Auto Loan</option>
</select>
<input id="amount" placeholder="Amount" class="w-full border p-2 mb-2" />
<button onclick="saveLead()" class="w-full bg-indigo-600 text-white p-2 mb-1">Save Lead</button>
<button onclick="closeModal()" class="w-full text-gray-500">Cancel</button>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E",
authDomain: "wisfox-lead-app.firebaseapp.com",
projectId: "wisfox-lead-app"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);
const provider = new GoogleAuthProvider();

let currentUser = null;

// LOGIN
window.googleLogin = async () => {
try {
const result = await signInWithPopup(auth, provider);
handleLogin(result.user);
} catch {
await signInWithRedirect(auth, provider);
}
};

async function handleLogin(user){
const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
if(snap.empty){
authBox.classList.add('hidden');
signupBox.classList.remove('hidden');
window.tempUser=user;return;
}
currentUser=snap.docs[0].data();
startApp();
}

// SIGNUP
window.completeSignup = async () => {
const user=window.tempUser;
const mobileVal=(mobile.value||'').trim();
const locationVal=(location.value||'').trim();
if(!mobileVal||!locationVal) return alert('Enter full details');
const role=user.email==='nil000nilesh@gmail.com'?'admin':'new';
await setDoc(doc(db,'users',user.uid),{name:user.displayName,email:user.email,mobile:mobileVal,location:locationVal,role,parentEmail:null});
currentUser={name:user.displayName,email:user.email,role};
signupBox.classList.add('hidden');
startApp();
};

function startApp(){
app.classList.remove('hidden');
loadLeads();
if(currentUser.role==='admin'){adminPanel.classList.remove('hidden');loadNewUsers();}
if(currentUser.role==='dsa'){dsaPanel.classList.remove('hidden');mySubList.classList.remove('hidden');loadMySubDSA();}
}

window.logout=()=>signOut(auth).then(()=>location.reload());

// PAGE SWITCH
window.showPage=(p)=>{
leadsPage.classList.toggle('hidden',p!=='leads');
usersPage.classList.toggle('hidden',p!=='users');
};

// LOAD LEADS
function loadLeads(){
onSnapshot(collection(db,'leads'),snap=>{
list.innerHTML='';
snap.forEach(d=>{
const l=d.data();
if(currentUser.role==='subdsa'&&l.agentEmail!==currentUser.email)return;
list.innerHTML+=`<div class='border p-2 rounded'><b>${l.name}</b><br>${l.type} | â‚¹${l.amount}<br>ðŸ“± ${l.phone}</div>`;
});
});}

// SAVE LEAD (FIXED)
window.saveLead=async()=>{
const nameVal=name.value.trim();
const phoneVal=phone.value.trim();
const amountVal=amount.value.trim();
if(!nameVal||!phoneVal||!amountVal) return alert('Fill all fields');
await addDoc(collection(db,'leads'),{name:nameVal,phone:phoneVal,type:type.value,amount:amountVal,status:'Pending',agentEmail:currentUser.email,created:new Date()});
closeModal();
name.value='';phone.value='';amount.value='';
};

window.openModal=()=>modal.classList.remove('hidden');
window.closeModal=()=>modal.classList.add('hidden');

// ADMIN USERS
function loadNewUsers(){
onSnapshot(collection(db,'users'),snap=>{
userList.innerHTML='';
snap.forEach(d=>{const u=d.data();if(u.role!=='new')return;userList.innerHTML+=`<div class='border p-2 rounded'>${u.name}<br>${u.email}<button onclick="setRole('${d.id}','dsa')" class='text-xs bg-green-200 px-2 ml-1'>Make DSA</button></div>`;});});}
window.setRole=async(id,role)=>updateDoc(doc(db,'users',id),{role});

// DSA SUBDSA
window.createSubDSA=async()=>{
const email=subEmail.value.trim();
const snap=await getDocs(query(collection(db,'users'),where('email','==',email)));
if(snap.empty)return alert('User not found');
const docSnap=snap.docs[0];
if(docSnap.data().role!=='new')return alert('User already engaged');
await updateDoc(doc(db,'users',docSnap.id),{role:'subdsa',parentEmail:currentUser.email});
alert('SubDSA created');
};

function loadMySubDSA(){
const q=query(collection(db,'users'),where('parentEmail','==',currentUser.email));
onSnapshot(q,snap=>{subList.innerHTML='';snap.forEach(d=>{const u=d.data();subList.innerHTML+=`<div class='border p-2 rounded bg-blue-50'><b>${u.name}</b><br>${u.email}<br>${u.mobile}</div>`;});});}

</script>
</body>
</html>
