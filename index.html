<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wisefox LeadApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .input-field:focus { border-color: #4F46E5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex justify-center items-center">

    <div class="w-full max-w-md h-full sm:h-[90vh] sm:rounded-3xl bg-white shadow-2xl relative flex flex-col overflow-hidden">
        
        <div class="bg-indigo-600 text-white p-5 pt-8 shadow-md z-10">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-xl tracking-tight"><i class="fa-solid fa-fox mr-2"></i>Wisefox</h2>
                    <p class="text-xs text-indigo-200 opacity-90" id="userRoleDisplay">Lead Management System</p>
                </div>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                    <i class="fa-solid fa-power-off text-white"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-4 relative">

            <div id="authBox" class="h-full flex flex-col justify-center items-center space-y-6 fade-in">
                <div class="text-center mb-4">
                    <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-3xl">
                        <i class="fa-solid fa-user-lock"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800">Welcome Back</h3>
                </div>
                <button onclick="googleLogin()" class="w-full max-w-xs bg-white border border-slate-300 text-slate-700 font-medium py-3 rounded-xl shadow-sm hover:bg-slate-50 hover:shadow-md transition flex items-center justify-center gap-3">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="G">
                    Continue with Google
                </button>
            </div>

            <div id="signupBox" class="hidden h-full flex flex-col justify-center fade-in">
                <h3 class="text-xl font-bold mb-1 text-slate-800">Complete Profile</h3>
                <div class="space-y-4 mt-4">
                    <input id="mobile" type="number" placeholder="Mobile Number (10 digits)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <input id="location" placeholder="Location / City" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <button onclick="completeSignup()" class="w-full bg-indigo-600 text-white font-semibold py-3.5 rounded-xl shadow-lg mt-4">
                        Create Account
                    </button>
                </div>
            </div>

            <div id="app" class="hidden pb-20 fade-in">
                
                <div class="bg-slate-200/50 p-1 rounded-xl flex mb-6 sticky top-0 backdrop-blur-md z-10 border border-slate-200">
                    <button onclick="showPage('leads')" id="tab-leads" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-white text-indigo-600 shadow-sm">Leads</button>
                    <button onclick="showPage('users')" id="tab-users" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 transition-all">Team</button>
                </div>

                <div id="leadsPage">
                    <button onclick="openModal()" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3 rounded-xl shadow-lg mb-5 font-medium flex items-center justify-center">
                        <i class="fa-solid fa-plus-circle mr-2"></i> Generate New Lead
                    </button>
                    <div id="list" class="space-y-3 pb-10"></div>
                </div>

                <div id="usersPage" class="hidden space-y-6">
                    
                    <div id="dsaPanel" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wide">Add Sub-DSA</h3>
                        <div class="space-y-3">
                            <input id="subEmail" placeholder="User Email" class="input-field w-full border border-slate-200 rounded-lg p-2.5 text-sm" />
                            <input id="subMobile" type="number" placeholder="User Mobile (10 digits)" class="input-field w-full border border-slate-200 rounded-lg p-2.5 text-sm" />
                            <button onclick="createSubDSA()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-medium">Link Sub-DSA</button>
                        </div>
                    </div>

                    <div id="mySubList" class="hidden">
                        <h3 class="font-bold text-slate-700 mb-2">My Team</h3>
                        <div id="subList" class="space-y-2"></div>
                    </div>

                    <div id="adminPanel" class="hidden">
                        <h3 class="font-bold text-slate-700 mb-3">All Users Directory</h3>
                        <div id="userList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">New Lead Details</h3>
            <div class="space-y-3">
                <input id="leadName" placeholder="Client Name" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                <input id="leadPhone" type="number" placeholder="Mobile No (10 Digits)" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                
                <textarea id="leadAddress" placeholder="Full Address / City" rows="2" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500"></textarea>
                
                <select id="type" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500">
                    <option>Personal Loan</option>
                    <option>Home Loan</option>
                    <option>Business Loan</option>
                    <option>Auto Loan</option>
                </select>
                <input id="leadAmount" placeholder="Amount Required" type="number" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                <div class="flex gap-2 mt-4 pt-2 border-t border-slate-100">
                    <button onclick="closeModal()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
                    <button onclick="saveLead()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg shadow hover:bg-indigo-700">Save Lead</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Update Status</h3>
            <select id="newStatus" class="w-full border p-3 rounded-lg mb-4 bg-slate-50 focus:outline-none">
                <option>Pending</option>
                <option>Contacted</option>
                <option>In Process</option>
                <option>Sanctioned</option>
                <option>Disbursed</option>
                <option>Rejected</option>
            </select>
            <div class="flex gap-2">
                <button onclick="closeStatusModal()" class="flex-1 text-slate-500">Cancel</button>
                <button onclick="saveStatus()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Update</button>
            </div>
        </div>
    </div>

    <div id="subDSAModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-slate-800">Assign Parent DSA</h3>
            <label class="text-xs font-bold text-slate-600 uppercase">Select DSA</label>
            <div class="relative mb-4 mt-2">
                <select id="modalDSASelect" class="w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none font-medium text-slate-700">
                    <option value="">-- Choose DSA --</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="closeSubDSAModal()" class="flex-1 text-slate-500 py-2 hover:bg-slate-50 rounded-lg">Cancel</button>
                <button onclick="confirmSubDSALink()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg shadow">Link Now</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E",
            authDomain: "wisfox-lead-app.firebaseapp.com",
            projectId: "wisfox-lead-app"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const db = getFirestore(appFirebase);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        
        // --- NEW VARIABLES FOR LEAD FILTERING ---
        window.mySubDSAEmails = []; // Store emails of SubDSAs
        window.latestLeadsSnap = null; // Store latest leads data

        window.googleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                handleLogin(result.user);
            } catch (error) { 
                console.error("Google Login Error:", error);
                await signInWithRedirect(auth, provider); 
            }
        };

        async function handleLogin(user){
            const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
            if(snap.empty){
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('signupBox').classList.remove('hidden');
                window.tempUser=user; 
                return;
            }
            currentUser = snap.docs[0].data();
            currentUser.id = snap.docs[0].id; 
            startApp();
        }

        window.completeSignup = async () => {
            const user = window.tempUser;
            const mobileVal = (document.getElementById('mobile').value||'').trim();
            const locationVal = (document.getElementById('location').value||'').trim();
            
            if(!mobileVal || !locationVal) return alert('Enter full details');
            if(mobileVal.length !== 10) return alert('Mobile number must be exactly 10 digits!');

            const role = user.email === 'nil000nilesh@gmail.com' ? 'admin' : 'new';
            const q = query(collection(db, "users"), where("email", "==", user.email));
            const snap = await getDocs(q);
            
            if(!snap.empty){
                const existingId = snap.docs[0].id;
                await updateDoc(doc(db,'users',existingId), { mobile: mobileVal, location: locationVal });
                currentUser = snap.docs[0].data();
                currentUser.id = existingId;
            } else {
                await setDoc(doc(db,'users',user.uid), {
                    name: user.displayName, email: user.email, mobile: mobileVal, location: locationVal, role, parentEmail: null
                });
                currentUser = {name: user.displayName, email: user.email, role, mobile: mobileVal, location: locationVal};
            }

            document.getElementById('signupBox').classList.add('hidden');
            startApp();
        };

        function startApp(){
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            
            // Show Role in Header
            document.getElementById('userRoleDisplay').innerText = `Logged in as: ${currentUser.role.toUpperCase()}`;

            loadLeads();
            
            if(currentUser.role === 'admin'){
                document.getElementById('adminPanel').classList.remove('hidden');
                loadNewUsers();
            }
            if(currentUser.role === 'dsa'){
                document.getElementById('dsaPanel').classList.remove('hidden');
                document.getElementById('mySubList').classList.remove('hidden');
                loadMySubDSA();
            }
        }

        window.logout = () => signOut(auth).then(() => location.reload());

        window.showPage = (p) => {
            document.getElementById('leadsPage').classList.toggle('hidden', p !== 'leads');
            document.getElementById('usersPage').classList.toggle('hidden', p !== 'users');
            const tLead = document.getElementById('tab-leads');
            const tUser = document.getElementById('tab-users');
            if(p === 'leads'){
                tLead.className = "flex-1 py-2 rounded-lg text-sm font-medium bg-white text-indigo-600 shadow-sm";
                tUser.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600";
            } else {
                tUser.className = "flex-1 py-2 rounded-lg text-sm font-medium bg-white text-indigo-600 shadow-sm";
                tLead.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600";
            }
        };

        function getStatusColor(status) {
            switch(status) {
                case 'Disbursed': return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                case 'Sanctioned': return 'bg-green-100 text-green-700 border-green-200';
                case 'Rejected': return 'bg-red-100 text-red-700 border-red-200';
                case 'In Process': return 'bg-blue-100 text-blue-700 border-blue-200';
                default: return 'bg-yellow-100 text-yellow-700 border-yellow-200';
            }
        }

        // --- UPDATED LEAD RENDERING LOGIC ---
        function renderLeads() {
            if (!window.latestLeadsSnap) return;
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            window.latestLeadsSnap.forEach(d => {
                const l = d.data();
                
                // --- VISIBILITY CHECK ---
                let canView = false;
                if (currentUser.role === 'admin') {
                    canView = true; // Admin sees all
                } else if (l.agentEmail === currentUser.email) {
                    canView = true; // User sees their own leads
                } else if (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail)) {
                    canView = true; // DSA sees leads from their Sub-DSAs
                }
                
                if (!canView) return; // Skip if not authorized

                const statusClass = getStatusColor(l.status||'Pending');
                
                let btn = '';
                if(currentUser.role === 'dsa' || currentUser.role === 'admin'){
                    btn = `<button onclick="openStatusModal('${d.id}','${l.status||'Pending'}')" class='text-xs font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded'>Edit Status</button>`;
                }
                let adminBtns = '';
                if(currentUser.role === 'admin'){
                    adminBtns = `<button onclick="deleteLead('${d.id}')" class='text-xs text-red-500 bg-red-50 px-2 py-1 rounded ml-2'><i class="fa-solid fa-trash"></i></button>`;
                }

                list.innerHTML += `
                <div class='bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative mb-3'>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">${l.name}</h4>
                            <span class="text-xs font-semibold text-slate-500">${l.type}</span>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full font-bold border ${statusClass}">${l.status||'Pending'}</span>
                    </div>
                    
                    <div class="mb-3 mt-1 space-y-1 bg-slate-50 p-2 rounded-lg border border-slate-100">
                         <div class="text-sm text-slate-600"><i class="fa-solid fa-phone text-slate-400 mr-2 w-4"></i> ${l.phone}</div>
                         <div class="text-sm text-slate-600"><i class="fa-solid fa-location-dot text-slate-400 mr-2 w-4"></i> ${l.address || 'NA'}</div>
                    </div>

                    <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-100">
                        <div>
                            <div class="text-sm font-bold text-slate-800">â‚¹${Number(l.amount).toLocaleString('en-IN')}</div>
                            <div class="text-[10px] text-indigo-700 font-bold bg-indigo-100 px-2 py-1 rounded mt-1 inline-block"><i class="fa-regular fa-user mr-1"></i> By: ${l.agentName || 'Unknown'}</div>
                        </div>
                        <div class="flex items-center">${btn} ${adminBtns}</div>
                    </div>
                </div>`;
            });
        }

        function loadLeads(){
            onSnapshot(collection(db,'leads'), snap => {
                window.latestLeadsSnap = snap;
                renderLeads();
            });
        }

        window.saveLead = async () => {
            const name = document.getElementById('leadName').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const address = document.getElementById('leadAddress').value.trim();
            const amount = document.getElementById('leadAmount').value.trim();
            const type = document.getElementById('type').value;

            if(!name || !phone || !amount || !address) return alert('Please fill all fields including Address!');
            if(phone.length !== 10) return alert('Mobile number must be exactly 10 digits!');
            
            const userSnap = await getDocs(query(collection(db,'users'), where('email','==',currentUser.email)));
            if(!userSnap.empty && userSnap.docs[0].data().blocked) return alert('Blocked by Admin');

            await addDoc(collection(db,'leads'), {
                name, phone, address, type, amount: Number(amount)||0, status: 'Pending', 
                agentEmail: currentUser.email, agentName: currentUser.name || 'Unknown', created: new Date()
            });
            
            closeModal();
            document.getElementById('leadName').value='';
            document.getElementById('leadPhone').value='';
            document.getElementById('leadAddress').value='';
            document.getElementById('leadAmount').value='';
        };

        window.openModal = () => document.getElementById('modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        let currentLeadId = null;
        window.openStatusModal = (id, status) => {
            currentLeadId = id;
            document.getElementById('newStatus').value = status || 'Pending';
            document.getElementById('statusModal').classList.remove('hidden');
        };
        window.closeStatusModal = () => document.getElementById('statusModal').classList.add('hidden');
        window.saveStatus = async () => {
            await updateDoc(doc(db,'leads',currentLeadId), {status: document.getElementById('newStatus').value});
            closeStatusModal();
        };

        // ADMIN USERS
        let targetSubDSAId = null; 

        function loadNewUsers(){
            const dsaQuery = query(collection(db,'users'), where('role','==','dsa'));
            onSnapshot(dsaQuery, snap => {
                const sel = document.getElementById('modalDSASelect');
                if(!sel) return;
                sel.innerHTML = '<option value="">-- Choose DSA --</option>';
                snap.forEach(d => {
                    const u = d.data();
                    sel.innerHTML += `<option value="${u.email}">${u.name||u.email}</option>`;
                });
            });

            onSnapshot(collection(db,'users'), snap => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    let roleBadgeColor = 'bg-gray-100 text-gray-600';
                    if(u.role === 'admin') roleBadgeColor = 'bg-red-100 text-red-700';
                    if(u.role === 'dsa') roleBadgeColor = 'bg-purple-100 text-purple-700';
                    if(u.role === 'subdsa') roleBadgeColor = 'bg-blue-100 text-blue-700';

                    let actionButtons = '';
                    if(u.role !== 'admin') {
                        let makeDSABtn = '';
                        if(u.role !== 'dsa') makeDSABtn = `<button onclick="setRole('${d.id}','dsa')" class='text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200'>Make DSA</button>`;
                        const makeSubDSABtn = `<button onclick="openSubDSAModal('${d.id}')" class='text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200 ml-1'>Make SubDSA</button>`;

                        let blockBtn = ''; let deleteUserBtn = '';
                        if(currentUser.role === 'admin'){
                            blockBtn = `<button onclick="toggleBlock('${d.id}','${u.blocked?'yes':'no'}')" class='text-[10px] ${u.blocked ? 'bg-amber-500 text-white' : 'bg-amber-50 text-amber-700'} px-2 py-1 rounded ml-1 border border-amber-200'>${u.blocked ? 'Unblock' : 'Block'}</button>`;
                            deleteUserBtn = `<button onclick="deleteUser('${d.id}')" class='text-[10px] bg-red-50 text-red-700 px-2 py-1 rounded ml-1 border border-red-200'><i class="fa-solid fa-trash"></i></button>`;
                        }
                        actionButtons = `<div class="flex flex-wrap gap-1 mt-1 pt-2 border-t border-slate-50">${makeDSABtn} ${makeSubDSABtn} ${blockBtn} ${deleteUserBtn}</div>`;
                    } else {
                         actionButtons = `<div class="text-[10px] text-slate-400 mt-1 pt-2 border-t border-slate-50 italic">Admin Access (Protected)</div>`;
                    }

                    userList.innerHTML += `
                    <div class='bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-2'>
                        <div class="flex justify-between items-start">
                            <div class="w-full">
                                <div class="font-bold text-sm text-slate-800">${u.name||'Unknown'}</div>
                                <div class="text-xs text-slate-500 mb-1">${u.email}</div>
                                <div class="text-[10px] text-slate-500 bg-slate-50 p-1.5 rounded-md flex items-center gap-2">
                                    <span><i class="fa-solid fa-phone text-slate-400 mr-1"></i>${u.mobile || 'NA'}</span><span class="text-slate-300">|</span><span><i class="fa-solid fa-map-pin text-slate-400 mr-1"></i>${u.location || 'NA'}</span>
                                </div>
                            </div>
                            <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${roleBadgeColor} whitespace-nowrap ml-2">${u.role||'new'}</span>
                        </div>
                        ${actionButtons}
                    </div>`;
                });
            });
        }

        window.openSubDSAModal = (id) => { targetSubDSAId = id; document.getElementById('subDSAModal').classList.remove('hidden'); }
        window.closeSubDSAModal = () => { targetSubDSAId = null; document.getElementById('subDSAModal').classList.add('hidden'); }

        window.confirmSubDSALink = async () => {
            const parentEmail = document.getElementById('modalDSASelect').value;
            if(!parentEmail) return alert('Please select a DSA first');
            if(targetSubDSAId) {
                await updateDoc(doc(db,'users',targetSubDSAId), {role:'subdsa', parentEmail:parentEmail});
                alert('User linked to DSA successfully');
                closeSubDSAModal();
            }
        }

        window.deleteUser = async(id) => { if(currentUser.role === 'admin' && confirm('Delete this user?')) await deleteDoc(doc(db,'users',id)); };
        window.toggleBlock = async(id, state) => { if(currentUser.role === 'admin') await updateDoc(doc(db,'users',id), {blocked: (state !== 'yes')}); };
        window.setRole = async(id, role) => updateDoc(doc(db,'users',id), {role});
        window.deleteLead = async(id) => { if(currentUser.role === 'admin' && confirm('Delete this lead?')) await deleteDoc(doc(db,'leads',id)); };

        window.createSubDSA = async () => {
            const email = document.getElementById('subEmail').value.trim();
            const mobile = document.getElementById('subMobile').value.trim();
            if(mobile.length !== 10) return alert('Sub-DSA Mobile number must be 10 digits!');
            const snap = await getDocs(query(collection(db,'users'), where('email','==',email)));
            if(snap.empty) return alert('User not found');
            const docSnap = snap.docs[0];
            if(docSnap.data().role !== 'new') return alert('User already assigned');
            await updateDoc(doc(db,'users',docSnap.id), {role:'subdsa', parentEmail:currentUser.email});
            alert('SubDSA added');
        };

        function loadMySubDSA(){
            const q = query(collection(db,'users'), where('parentEmail','==',currentUser.email));
            onSnapshot(q, snap => {
                const subList = document.getElementById('subList');
                subList.innerHTML = '';
                window.mySubDSAEmails = []; // Reset emails array
                
                snap.forEach(d => {
                    const u = d.data();
                    window.mySubDSAEmails.push(u.email); // Store email for lead filtering
                    subList.innerHTML += `
                    <div class='bg-blue-50/50 p-3 rounded-lg border border-blue-100 flex items-center gap-3'>
                        <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></div>
                        <div><div class="font-bold text-sm text-slate-700">${u.name}</div><div class="text-xs text-slate-500">${u.mobile}</div></div>
                    </div>`;
                });
                
                renderLeads(); // Re-render leads now that we have updated SubDSA list
            });
        }
    </script>
</body>
</html>
