<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wisefox LeadApp Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .input-field:focus { border-color: #4F46E5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-enter { animation: slideDown 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex justify-center items-center relative">

    <div id="toast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] px-5 py-2.5 rounded-full shadow-xl text-sm font-semibold text-white flex items-center gap-2 min-w-[200px] justify-center">
        <i id="toastIcon" class="fa-solid fa-circle-check"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <div class="w-full max-w-md h-full sm:h-[90vh] sm:rounded-3xl bg-white shadow-2xl relative flex flex-col overflow-hidden">
        
        <div class="bg-indigo-600 text-white p-4 pt-6 shadow-md z-10 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-lg tracking-tight"><i class="fa-solid fa-fox mr-2"></i>Wisefox Pro</h2>
                    <p class="text-[10px] text-indigo-200 opacity-90" id="userRoleDisplay">Lead Management System</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openCalculator()" id="innerCalcBtn" class="hidden bg-white/20 hover:bg-white/30 w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm text-sm">
                        <i class="fa-solid fa-calculator text-white"></i>
                    </button>
                    <button onclick="logout()" id="logoutBtn" class="hidden bg-red-500/80 hover:bg-red-500 w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm text-sm">
                        <i class="fa-solid fa-power-off text-white"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-4 relative">

            <div id="authBox" class="h-full flex flex-col justify-center items-center fade-in">
                <div class="text-center mb-4">
                    <div class="w-14 h-14 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-600 text-xl shadow-sm">
                        <i class="fa-solid fa-user-lock"></i>
                    </div>
                    <h3 id="authTitle" class="text-xl font-bold text-slate-800">Welcome Back</h3>
                    <p id="authSubtitle" class="text-xs text-slate-500">Sign in to your account</p>
                </div>

                <div class="w-full max-w-xs space-y-3 mt-2">
                    <input id="emailInput" type="email" placeholder="Email Address" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm focus:outline-none" />
                    <input id="passwordInput" type="password" placeholder="Password (Min 6 chars)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm focus:outline-none" />
                    <button id="mainAuthBtn" onclick="handleEmailAuth()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg shadow-md transition mt-2 text-sm">
                        Login
                    </button>
                    <div class="text-center text-[11px] text-slate-600 mt-2">
                        <span id="authToggleText">Don't have an account?</span>
                        <button onclick="toggleAuthMode()" class="text-indigo-600 font-bold ml-1 hover:underline">Sign Up</button>
                    </div>
                    <div class="flex items-center my-3">
                        <div class="flex-grow border-t border-slate-200"></div><span class="px-2 text-slate-400 text-[10px] font-medium">OR</span><div class="flex-grow border-t border-slate-200"></div>
                    </div>
                    <button onclick="googleLogin()" class="w-full bg-white border border-slate-300 text-slate-700 font-medium py-2.5 rounded-lg shadow-sm hover:bg-slate-50 hover:shadow-md transition flex items-center justify-center gap-2 text-sm">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4" alt="G"> Continue with Google
                    </button>
                    <button onclick="openCalculator()" class="w-full bg-slate-800 text-white font-medium py-2.5 rounded-lg shadow-sm hover:bg-slate-900 transition flex items-center justify-center gap-2 mt-3 text-sm">
                        <i class="fa-solid fa-calculator"></i> Financial Calculator
                    </button>
                </div>
            </div>

            <div id="calculatorPage" class="hidden h-full flex-col fade-in pb-2">
                <div class="flex items-center mb-3 border-b border-slate-200 pb-2">
                    <button onclick="closeCalculator()" class="text-slate-500 hover:text-indigo-600 transition mr-2"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                    <h3 class="text-lg font-bold text-slate-800">Smart Calculator</h3>
                </div>
                <div class="space-y-2.5">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">What to calculate?</label>
                        <select id="calcMode" onchange="updateCalcUI()" class="w-full border border-slate-300 rounded-lg p-2 mt-0.5 bg-white focus:outline-none font-medium text-indigo-700 text-sm">
                            <option value="emi">Calculate EMI</option>
                            <option value="amount">Calculate Loan Amount</option>
                            <option value="roi">Calculate ROI (%)</option>
                            <option value="term">Calculate Tenure (Term)</option>
                        </select>
                    </div>
                    <div id="calcInputAmount" class="relative"><label class="text-[11px] font-semibold text-slate-600">Loan Amount (₹)</label><input id="cAmount" type="number" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" /></div>
                    <div id="calcInputEMI" class="relative hidden"><label class="text-[11px] font-semibold text-slate-600">Monthly EMI (₹)</label><input id="cEmi" type="number" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" /></div>
                    <div id="calcInputROI" class="relative"><label class="text-[11px] font-semibold text-slate-600">Rate of Interest (% p.a.)</label><input id="cRoi" type="number" step="0.1" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" /></div>
                    <div id="calcInputTerm" class="relative"><label class="text-[11px] font-semibold text-slate-600">Tenure (in Months)</label><input id="cTerm" type="number" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" /></div>
                    <button onclick="performCalculation()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg shadow-md mt-2 text-sm">Calculate</button>

                    <div id="calcResultBox" class="hidden mt-3 bg-slate-800 text-white p-3 rounded-xl shadow-lg">
                        <div class="text-center mb-2 border-b border-slate-600 pb-2">
                            <p class="text-[10px] text-emerald-400 font-semibold uppercase tracking-wider mb-0.5" id="resMainTitle">Your Result</p>
                            <h2 class="text-xl font-bold" id="resMainValue">₹0</h2>
                        </div>
                        <div class="space-y-1.5 text-[11px]">
                            <div class="flex justify-between"><span class="text-slate-400">Principal Amount</span><span class="font-semibold" id="resPrincipal">₹0</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Total Interest Paid</span><span class="font-semibold text-red-400" id="resInterest">₹0</span></div>
                            <div class="flex justify-between border-t border-slate-600 pt-1.5"><span class="text-slate-300 font-bold">Total Payment</span><span class="font-bold text-emerald-400" id="resTotal">₹0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signupBox" class="hidden h-full flex flex-col justify-center fade-in">
                <h3 class="text-lg font-bold mb-1 text-slate-800">Complete Profile</h3>
                <p class="text-xs text-slate-500 mb-4">Please provide your details to continue.</p>
                <div class="space-y-3">
                    <input id="profileName" placeholder="Full Name" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm" />
                    <input id="mobile" type="number" placeholder="Mobile Number (10 digits)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm" />
                    <input id="location" placeholder="Location / City" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm" />
                    <button onclick="completeSignup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg shadow-md mt-2 text-sm">Save & Continue</button>
                </div>
            </div>

            <div id="app" class="hidden pb-16 fade-in">
                
                <div class="bg-slate-200/50 p-1 rounded-lg flex mb-4 sticky top-0 backdrop-blur-md z-10 border border-slate-200">
                    <button onclick="showPage('leads')" id="tab-leads" class="flex-1 py-1.5 rounded-md text-xs font-medium transition-all bg-white text-indigo-600 shadow-sm">Leads</button>
                    <button onclick="showPage('users')" id="tab-users" class="flex-1 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-indigo-600 transition-all">Team</button>
                </div>

                <div id="leadsPage">
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-indigo-50 border border-indigo-100 p-2 rounded-lg text-center shadow-sm">
                            <div class="text-[10px] text-indigo-500 font-bold uppercase">Total Leads</div>
                            <div class="text-lg font-black text-indigo-700" id="dashCount">0</div>
                        </div>
                        <div class="bg-emerald-50 border border-emerald-100 p-2 rounded-lg text-center shadow-sm col-span-2">
                            <div class="text-[10px] text-emerald-600 font-bold uppercase">Total Business</div>
                            <div class="text-lg font-black text-emerald-700" id="dashAmount">₹0</div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="openModal()" class="flex-1 bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-2 rounded-lg shadow-md font-medium flex items-center justify-center hover:shadow-lg transition text-xs">
                            <i class="fa-solid fa-plus-circle mr-1.5"></i> Add Lead
                        </button>
                        <select id="sortSelect" onchange="changeSort()" class="bg-white border border-slate-200 text-slate-600 text-[10px] rounded-lg px-2 py-2 focus:outline-none shadow-sm font-semibold w-24">
                            <option value="new">Newest</option>
                            <option value="amtHigh">Amt: High</option>
                            <option value="amtLow">Amt: Low</option>
                        </select>
                        <button onclick="exportCSV()" id="exportBtn" class="hidden bg-slate-800 text-white px-3 py-2 rounded-lg shadow-md hover:bg-slate-900 transition text-[10px] font-semibold">
                            <i class="fa-solid fa-file-csv"></i>
                        </button>
                    </div>

                    <div id="list" class="space-y-3 pb-10"></div>
                </div>

                <div id="usersPage" class="hidden space-y-4">
                    <div id="dsaPanel" class="hidden bg-white p-3 rounded-lg shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wide">Add Sub-DSA</h3>
                        <div class="space-y-2">
                            <input id="subEmail" placeholder="User Email" class="input-field w-full border border-slate-200 rounded-md p-2 text-xs" />
                            <input id="subMobile" type="number" placeholder="User Mobile (10 digits)" class="input-field w-full border border-slate-200 rounded-md p-2 text-xs" />
                            <button onclick="createSubDSA()" class="w-full bg-blue-600 text-white py-2 rounded-md text-xs font-medium">Link Sub-DSA</button>
                        </div>
                    </div>
                    <div id="mySubList" class="hidden"><h3 class="font-bold text-slate-700 mb-2 text-sm">My Team</h3><div id="subList" class="space-y-2"></div></div>
                    <div id="adminPanel" class="hidden"><h3 class="font-bold text-slate-700 mb-2 text-sm">All Users Directory</h3><div id="userList" class="space-y-2"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-3 text-slate-800">New Lead Details</h3>
            <div class="space-y-2.5">
                <input id="leadName" placeholder="Client Name" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <input id="leadPhone" type="number" placeholder="Mobile No (10 Digits)" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <textarea id="leadAddress" placeholder="Full Address / City" rows="2" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-indigo-500"></textarea>
                <select id="type" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-indigo-500">
                    <option>Personal Loan</option><option>Home Loan</option><option>Business Loan</option><option>Auto Loan</option>
                </select>
                <input id="leadAmount" placeholder="Amount Required" type="number" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <div class="flex gap-2 mt-3 pt-2 border-t border-slate-100">
                    <button onclick="closeModal()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-semibold">Cancel</button>
                    <button id="submitLeadBtn" onclick="saveLead()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg shadow hover:bg-indigo-700 text-sm font-bold transition">Save Lead</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-2xl">
            <h3 class="font-bold text-md mb-3">Update Status</h3>
            <select id="newStatus" class="w-full border p-2 rounded-lg mb-3 bg-slate-50 text-sm focus:outline-none">
                <option>Pending</option><option>Contacted</option><option>In Process</option><option>Sanctioned</option><option>Disbursed</option><option>Rejected</option>
            </select>
            <div class="flex gap-2">
                <button onclick="closeStatusModal()" class="flex-1 text-slate-500 text-sm">Cancel</button>
                <button onclick="saveStatus()" class="flex-1 bg-indigo-600 text-white py-1.5 rounded-lg text-sm font-semibold">Update</button>
            </div>
        </div>
    </div>

    <div id="subDSAModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-2xl">
            <h3 class="font-bold text-md mb-1 text-slate-800">Assign Parent DSA</h3>
            <label class="text-[10px] font-bold text-slate-600 uppercase">Select DSA</label>
            <select id="modalDSASelect" class="w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-1 mb-3 text-sm focus:outline-none"><option value="">-- Choose DSA --</option></select>
            <div class="flex gap-2">
                <button onclick="closeSubDSAModal()" class="flex-1 text-slate-500 py-1.5 rounded-lg text-sm">Cancel</button>
                <button onclick="confirmSubDSALink()" class="flex-1 bg-blue-600 text-white py-1.5 rounded-lg shadow text-sm">Link Now</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E", authDomain: "wisfox-lead-app.firebaseapp.com", projectId: "wisfox-lead-app" };
        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const db = getFirestore(appFirebase);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        window.mySubDSAEmails = [];
        window.latestLeadsSnap = null;
        window.processedLeads = []; // For sorting and exporting
        window.currentSort = 'new'; // default sort

        // --- CUSTOM TOAST NOTIFICATIONS ---
        window.showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg;
            
            toast.className = `toast-enter fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] px-5 py-2.5 rounded-full shadow-xl text-sm font-semibold text-white flex items-center gap-2 min-w-[200px] justify-center ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            icon.className = type === 'success' ? 'fa-solid fa-circle-check' : 'fa-solid fa-circle-exclamation';
            
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3500);
        };

        // --- AUTH LOGIC ---
        let isLoginMode = true;
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? 'Welcome Back' : 'Create Account';
            document.getElementById('authSubtitle').innerText = isLoginMode ? 'Sign in to your account' : 'Sign up to get started';
            document.getElementById('mainAuthBtn').innerText = isLoginMode ? 'Login' : 'Sign Up';
            document.getElementById('authToggleText').innerText = isLoginMode ? "Don't have an account?" : "Already have an account?";
            event.target.innerText = isLoginMode ? 'Sign Up' : 'Login';
        };

        window.handleEmailAuth = async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            if(!email || !password) return showToast("Enter Email and Password!", 'error');
            if(password.length < 6) return showToast("Password min 6 chars!", 'error');
            try {
                let result = isLoginMode ? await signInWithEmailAndPassword(auth, email, password) : await createUserWithEmailAndPassword(auth, email, password);
                await handleLogin(result.user);
            } catch (error) { showToast(error.message.split('/')[1] || "Auth Failed", 'error'); }
        };

        window.googleLogin = async () => {
            try { const result = await signInWithPopup(auth, provider); await handleLogin(result.user); } 
            catch (error) { signInWithRedirect(auth, provider); }
        };

        async function handleLogin(user){
            const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
            if(snap.empty){
                document.getElementById('authBox').classList.add('hidden'); document.getElementById('signupBox').classList.remove('hidden');
                if(user.displayName) document.getElementById('profileName').value = user.displayName;
                window.tempUser = user; return;
            }
            currentUser = snap.docs[0].data(); currentUser.id = snap.docs[0].id; 
            showToast(`Welcome back, ${currentUser.name}!`);
            startApp();
        }

        window.completeSignup = async () => {
            const user = window.tempUser;
            const nameVal = document.getElementById('profileName').value.trim() || user.displayName || 'User';
            const mobileVal = document.getElementById('mobile').value.trim();
            const locationVal = document.getElementById('location').value.trim();
            if(!nameVal || !mobileVal || !locationVal) return showToast('Fill all details!', 'error');
            if(mobileVal.length !== 10) return showToast('Mobile must be 10 digits!', 'error');

            const role = user.email === 'nil000nilesh@gmail.com' ? 'admin' : 'new';
            const snap = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
            if(!snap.empty){
                const existingId = snap.docs[0].id;
                await updateDoc(doc(db,'users',existingId), { name: nameVal, mobile: mobileVal, location: locationVal });
                currentUser = snap.docs[0].data(); currentUser.id = existingId;
            } else {
                await setDoc(doc(db,'users',user.uid), { name: nameVal, email: user.email, mobile: mobileVal, location: locationVal, role, parentEmail: null });
                currentUser = {name: nameVal, email: user.email, role, mobile: mobileVal, location: locationVal};
            }
            document.getElementById('signupBox').classList.add('hidden');
            showToast('Account Created Successfully!');
            startApp();
        };

        function startApp(){
            document.getElementById('authBox').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden'); document.getElementById('innerCalcBtn').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = `Role: ${currentUser.role.toUpperCase()}`;
            
            if(currentUser.role === 'admin' || currentUser.role === 'dsa') document.getElementById('exportBtn').classList.remove('hidden');
            
            loadLeads();
            if(currentUser.role === 'admin'){ document.getElementById('adminPanel').classList.remove('hidden'); loadNewUsers(); }
            if(currentUser.role === 'dsa'){ document.getElementById('dsaPanel').classList.remove('hidden'); document.getElementById('mySubList').classList.remove('hidden'); loadMySubDSA(); }
        }

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- SORTING & WHATSAPP ---
        window.changeSort = () => { window.currentSort = document.getElementById('sortSelect').value; renderLeadsUI(); };

        window.shareOnWhatsApp = (name, amount, type, status) => {
            const text = `*New Lead Details*%0A%0A*Name:* ${name}%0A*Loan Type:* ${type}%0A*Amount:* ₹${Number(amount).toLocaleString('en-IN')}%0A*Status:* ${status}%0A%0A_Sent from Wisefox App_`;
            window.open(`https://wa.me/?text=${text}`, '_blank');
        };

        window.exportCSV = () => {
            if(window.processedLeads.length === 0) return showToast("No leads to export!", "error");
            let csv = "Name,Phone,Address,Type,Amount,Status,Agent\n";
            window.processedLeads.forEach(l => {
                csv += `"${l.name}","${l.phone}","${l.address}","${l.type}","${l.amount}","${l.status}","${l.agentName}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Wisefox_Leads.csv'; a.click();
            showToast("Report Exported Successfully!");
        };

        function renderLeadsUI() {
            const list = document.getElementById('list'); list.innerHTML = '';
            
            // Dashboard Variables
            let totalAmount = 0; let totalCount = window.processedLeads.length;

            // Sorting
            let sortedArr = [...window.processedLeads];
            if(window.currentSort === 'amtHigh') sortedArr.sort((a,b) => b.amount - a.amount);
            else if(window.currentSort === 'amtLow') sortedArr.sort((a,b) => a.amount - b.amount);
            else sortedArr.sort((a,b) => b.created - a.created); // Newest default

            sortedArr.forEach(l => {
                totalAmount += Number(l.amount);

                const statusClass = l.status === 'Disbursed' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 
                                  l.status === 'Rejected' ? 'bg-red-100 text-red-700 border-red-200' : 
                                  l.status === 'Sanctioned' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200';
                
                let btn = (currentUser.role === 'dsa' || currentUser.role === 'admin') ? `<button onclick="openStatusModal('${l.id}','${l.status}')" class='text-[10px] font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded'>Edit</button>` : '';
                let adminBtns = currentUser.role === 'admin' ? `<button onclick="deleteLead('${l.id}')" class='text-[10px] text-red-500 bg-red-50 px-2 py-1 rounded ml-1'><i class="fa-solid fa-trash"></i></button>` : '';
                let waBtn = `<button onclick="shareOnWhatsApp('${l.name}', '${l.amount}', '${l.type}', '${l.status}')" class="text-[12px] text-green-600 bg-green-50 px-2 py-1 rounded ml-1"><i class="fa-brands fa-whatsapp text-sm"></i></button>`;

                list.innerHTML += `
                <div class='bg-white p-3 rounded-xl shadow-sm border border-slate-200 relative mb-3'>
                    <div class="flex justify-between items-start mb-1.5">
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">${l.name}</h4>
                            <span class="text-[10px] font-semibold text-slate-500">${l.type}</span>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold border ${statusClass}">${l.status||'Pending'}</span>
                    </div>
                    <div class="mb-2 space-y-0.5 bg-slate-50 p-1.5 rounded-lg border border-slate-100">
                         <div class="text-xs text-slate-600"><i class="fa-solid fa-phone text-slate-400 mr-1.5 w-3"></i> ${l.phone}</div>
                         <div class="text-xs text-slate-600 truncate"><i class="fa-solid fa-location-dot text-slate-400 mr-1.5 w-3"></i> ${l.address || 'NA'}</div>
                    </div>
                    <div class="flex justify-between items-end mt-1.5 pt-1.5 border-t border-slate-100">
                        <div>
                            <div class="text-sm font-bold text-slate-800">₹${Number(l.amount).toLocaleString('en-IN')}</div>
                            <div class="text-[9px] text-indigo-700 font-bold bg-indigo-100 px-1.5 py-0.5 rounded mt-0.5 inline-block"><i class="fa-regular fa-user mr-1"></i> By: ${l.agentName}</div>
                        </div>
                        <div class="flex items-center">${waBtn} ${btn} ${adminBtns}</div>
                    </div>
                </div>`;
            });

            // Update Dashboard UI
            document.getElementById('dashCount').innerText = totalCount;
            document.getElementById('dashAmount').innerText = "₹" + (totalAmount >= 100000 ? (totalAmount/100000).toFixed(2) + "L" : totalAmount.toLocaleString('en-IN'));
        }

        function loadLeads(){
            onSnapshot(collection(db,'leads'), snap => {
                window.processedLeads = [];
                snap.forEach(d => {
                    const l = d.data(); l.id = d.id;
                    if(currentUser.role === 'admin' || l.agentEmail === currentUser.email || (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail))){
                        window.processedLeads.push(l);
                    }
                });
                renderLeadsUI();
            });
        }

        // --- FIXED LEAD SAVING (PREVENT DOUBLE CLICK) ---
        window.saveLead = async () => {
            const btn = document.getElementById('submitLeadBtn');
            const name = document.getElementById('leadName').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const address = document.getElementById('leadAddress').value.trim();
            const amount = document.getElementById('leadAmount').value.trim();
            const type = document.getElementById('type').value;

            if(!name || !phone || !amount || !address) return showToast('Fill all fields!', 'error');
            if(phone.length !== 10) return showToast('Mobile must be 10 digits!', 'error');
            
            // DISABLE BUTTON TO PREVENT DUPLICATES
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Saving...';
            btn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const userSnap = await getDocs(query(collection(db,'users'), where('email','==',currentUser.email)));
                if(!userSnap.empty && userSnap.docs[0].data().blocked) throw new Error('Blocked by Admin');

                await addDoc(collection(db,'leads'), {
                    name, phone, address, type, amount: Number(amount)||0, status: 'Pending', 
                    agentEmail: currentUser.email, agentName: currentUser.name || 'Unknown', created: Date.now()
                });
                
                showToast('Lead Generated Successfully!');
                closeModal();
                document.getElementById('leadName').value=''; document.getElementById('leadPhone').value='';
                document.getElementById('leadAddress').value=''; document.getElementById('leadAmount').value='';
            } catch(e) {
                showToast(e.message || 'Error saving lead', 'error');
            } finally {
                // RE-ENABLE BUTTON
                btn.disabled = false;
                btn.innerHTML = 'Save Lead';
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        };

        window.openModal = () => document.getElementById('modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        let currentLeadId = null;
        window.openStatusModal = (id, status) => { currentLeadId = id; document.getElementById('newStatus').value = status || 'Pending'; document.getElementById('statusModal').classList.remove('hidden'); };
        window.closeStatusModal = () => document.getElementById('statusModal').classList.add('hidden');
        window.saveStatus = async () => { 
            await updateDoc(doc(db,'leads',currentLeadId), {status: document.getElementById('newStatus').value}); 
            showToast('Status Updated!'); closeStatusModal(); 
        };

        // --- ADMIN & USERS LOGIC (Unchanged functionally, added Toasts) ---
        let targetSubDSAId = null; 
        function loadNewUsers(){
            onSnapshot(query(collection(db,'users'), where('role','==','dsa')), snap => {
                const sel = document.getElementById('modalDSASelect'); if(!sel) return;
                sel.innerHTML = '<option value="">-- Choose DSA --</option>';
                snap.forEach(d => { const u = d.data(); sel.innerHTML += `<option value="${u.email}">${u.name||u.email}</option>`; });
            });

            onSnapshot(collection(db,'users'), snap => {
                const userList = document.getElementById('userList'); userList.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    let rc = u.role === 'admin' ? 'bg-red-100 text-red-700' : u.role === 'dsa' ? 'bg-purple-100 text-purple-700' : u.role === 'subdsa' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600';
                    let act = '';
                    if(u.role !== 'admin') {
                        let md = u.role !== 'dsa' ? `<button onclick="setRole('${d.id}','dsa')" class='text-[9px] bg-green-50 text-green-700 px-1.5 py-1 rounded border border-green-200'>Make DSA</button>` : '';
                        let ms = `<button onclick="openSubDSAModal('${d.id}')" class='text-[9px] bg-blue-50 text-blue-700 px-1.5 py-1 rounded border border-blue-200 ml-1'>Make SubDSA</button>`;
                        let bl = currentUser.role === 'admin' ? `<button onclick="toggleBlock('${d.id}','${u.blocked?'yes':'no'}')" class='text-[9px] ${u.blocked ? 'bg-amber-500 text-white' : 'bg-amber-50 text-amber-700'} px-1.5 py-1 rounded ml-1 border border-amber-200'>${u.blocked ? 'Unblock' : 'Block'}</button>` : '';
                        let dl = currentUser.role === 'admin' ? `<button onclick="deleteUser('${d.id}')" class='text-[9px] bg-red-50 text-red-700 px-1.5 py-1 rounded ml-1 border border-red-200'><i class="fa-solid fa-trash"></i></button>` : '';
                        act = `<div class="flex flex-wrap gap-1 mt-1 pt-1.5 border-t border-slate-50">${md} ${ms} ${bl} ${dl}</div>`;
                    } else act = `<div class="text-[9px] text-slate-400 mt-1 pt-1.5 border-t border-slate-50 italic">Admin Access (Protected)</div>`;
                    
                    userList.innerHTML += `
                    <div class='bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-1.5'>
                        <div class="flex justify-between items-start">
                            <div class="w-full">
                                <div class="font-bold text-xs text-slate-800">${u.name||'Unknown'}</div>
                                <div class="text-[10px] text-slate-500 mb-1">${u.email}</div>
                            </div>
                            <span class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded ${rc}">${u.role||'new'}</span>
                        </div>
                        ${act}
                    </div>`;
                });
            });
        }

        window.openSubDSAModal = (id) => { targetSubDSAId = id; document.getElementById('subDSAModal').classList.remove('hidden'); }
        window.closeSubDSAModal = () => { targetSubDSAId = null; document.getElementById('subDSAModal').classList.add('hidden'); }
        window.confirmSubDSALink = async () => {
            const p = document.getElementById('modalDSASelect').value;
            if(!p) return showToast('Select DSA first', 'error');
            if(targetSubDSAId) { await updateDoc(doc(db,'users',targetSubDSAId), {role:'subdsa', parentEmail:p}); showToast('Linked to DSA!'); closeSubDSAModal(); }
        }

        window.deleteUser = async(id) => { if(currentUser.role === 'admin' && confirm('Delete?')) { await deleteDoc(doc(db,'users',id)); showToast('Deleted'); } };
        window.toggleBlock = async(id, state) => { if(currentUser.role === 'admin') { await updateDoc(doc(db,'users',id), {blocked: (state !== 'yes')}); showToast('Block status updated'); } };
        window.setRole = async(id, role) => { await updateDoc(doc(db,'users',id), {role}); showToast('Role Updated'); };
        window.deleteLead = async(id) => { if(currentUser.role === 'admin' && confirm('Delete lead?')) { await deleteDoc(doc(db,'leads',id)); showToast('Lead Deleted'); } };

        window.createSubDSA = async () => {
            const e = document.getElementById('subEmail').value.trim(); const m = document.getElementById('subMobile').value.trim();
            if(m.length !== 10) return showToast('10 digit mobile needed', 'error');
            const snap = await getDocs(query(collection(db,'users'), where('email','==',e)));
            if(snap.empty) return showToast('User not found', 'error');
            const d = snap.docs[0];
            if(d.data().role !== 'new') return showToast('User already assigned', 'error');
            await updateDoc(doc(db,'users',d.id), {role:'subdsa', parentEmail:currentUser.email}); showToast('SubDSA Added!');
        };

        function loadMySubDSA(){
            onSnapshot(query(collection(db,'users'), where('parentEmail','==',currentUser.email)), snap => {
                const subList = document.getElementById('subList'); subList.innerHTML = ''; window.mySubDSAEmails = []; 
                snap.forEach(d => {
                    const u = d.data(); window.mySubDSAEmails.push(u.email); 
                    subList.innerHTML += `<div class='bg-blue-50/50 p-2 rounded-lg border border-blue-100 flex items-center gap-2'><div class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-[10px]"><i class="fa-solid fa-user"></i></div><div><div class="font-bold text-xs text-slate-700">${u.name}</div><div class="text-[10px] text-slate-500">${u.mobile}</div></div></div>`;
                });
                renderLeadsUI(); 
            });
        }

        // TAB LOGIC + CALCULATOR LOGIC (Kept identical to previous turn)
        window.showPage = (p) => { document.getElementById('leadsPage').classList.toggle('hidden', p !== 'leads'); document.getElementById('usersPage').classList.toggle('hidden', p !== 'users'); const tLead = document.getElementById('tab-leads'); const tUser = document.getElementById('tab-users'); if(p === 'leads'){ tLead.className = "flex-1 py-1.5 rounded-md text-xs font-medium bg-white text-indigo-600 shadow-sm"; tUser.className = "flex-1 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-indigo-600"; } else { tUser.className = "flex-1 py-1.5 rounded-md text-xs font-medium bg-white text-indigo-600 shadow-sm"; tLead.className = "flex-1 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-indigo-600"; } };
        window.openCalculator = () => { document.getElementById('authBox').classList.add('hidden'); document.getElementById('app').classList.add('hidden'); document.getElementById('calculatorPage').classList.remove('hidden'); document.getElementById('calculatorPage').classList.add('flex'); document.getElementById('calcResultBox').classList.add('hidden'); };
        window.closeCalculator = () => { document.getElementById('calculatorPage').classList.add('hidden'); document.getElementById('calculatorPage').classList.remove('flex'); if (currentUser) { document.getElementById('app').classList.remove('hidden'); } else { document.getElementById('authBox').classList.remove('hidden'); } };
        window.updateCalcUI = () => { const mode = document.getElementById('calcMode').value; document.getElementById('calcInputAmount').classList.remove('hidden'); document.getElementById('calcInputEMI').classList.remove('hidden'); document.getElementById('calcInputROI').classList.remove('hidden'); document.getElementById('calcInputTerm').classList.remove('hidden'); document.getElementById('calcResultBox').classList.add('hidden'); if (mode === 'emi') document.getElementById('calcInputEMI').classList.add('hidden'); if (mode === 'amount') document.getElementById('calcInputAmount').classList.add('hidden'); if (mode === 'roi') document.getElementById('calcInputROI').classList.add('hidden'); if (mode === 'term') document.getElementById('calcInputTerm').classList.add('hidden'); document.getElementById('cAmount').value = ''; document.getElementById('cEmi').value = ''; document.getElementById('cRoi').value = ''; document.getElementById('cTerm').value = ''; };
        window.performCalculation = () => { const mode = document.getElementById('calcMode').value; const pInput = parseFloat(document.getElementById('cAmount').value); const eInput = parseFloat(document.getElementById('cEmi').value); const rInput = parseFloat(document.getElementById('cRoi').value); const nInput = parseFloat(document.getElementById('cTerm').value); let p = pInput || 0, e = eInput || 0, r = rInput || 0, n = nInput || 0; let resultMain = 0, totalPayment = 0, totalInterest = 0, finalP = 0; try { if (mode === 'emi') { if(!p || !r || !n) return showToast("Enter Loan Amount, ROI and Tenure.", "error"); let monthlyRate = r / 12 / 100; e = (p * monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1); resultMain = e; finalP = p; document.getElementById('resMainTitle').innerText = "Monthly EMI"; document.getElementById('resMainValue').innerText = "₹" + Math.round(resultMain).toLocaleString('en-IN'); } else if (mode === 'amount') { if(!e || !r || !n) return showToast("Enter EMI, ROI and Tenure.", "error"); let monthlyRate = r / 12 / 100; p = (e * (Math.pow(1 + monthlyRate, n) - 1)) / (monthlyRate * Math.pow(1 + monthlyRate, n)); resultMain = p; finalP = p; document.getElementById('resMainTitle').innerText = "Max Eligibility"; document.getElementById('resMainValue').innerText = "₹" + Math.round(resultMain).toLocaleString('en-IN'); } else if (mode === 'term') { if(!p || !e || !r) return showToast("Enter Amount, EMI and ROI.", "error"); let monthlyRate = r / 12 / 100; if (e <= p * monthlyRate) return showToast("EMI too low!", "error"); n = Math.log(e / (e - p * monthlyRate)) / Math.log(1 + monthlyRate); resultMain = Math.ceil(n); finalP = p; e = eInput; document.getElementById('resMainTitle').innerText = "Total Tenure"; document.getElementById('resMainValue').innerText = resultMain + " Months"; n = resultMain; } else if (mode === 'roi') { if(!p || !e || !n) return showToast("Enter Amount, EMI and Tenure.", "error"); if(e * n <= p) return showToast("Invalid inputs.", "error"); let low = 0.000001, high = 100.0, mid = 0; while (high - low > 0.00001) { mid = (low + high) / 2; let mRate = mid / 12 / 100; let calcE = (p * mRate * Math.pow(1 + mRate, n)) / (Math.pow(1 + mRate, n) - 1); if (calcE > e) high = mid; else low = mid; } resultMain = mid; finalP = p; document.getElementById('resMainTitle').innerText = "Rate of Interest"; document.getElementById('resMainValue').innerText = resultMain.toFixed(2) + "% p.a."; } totalPayment = e * n; totalInterest = totalPayment - finalP; document.getElementById('resPrincipal').innerText = "₹" + Math.round(finalP).toLocaleString('en-IN'); document.getElementById('resInterest').innerText = "₹" + Math.round(totalInterest > 0 ? totalInterest : 0).toLocaleString('en-IN'); document.getElementById('resTotal').innerText = "₹" + Math.round(totalPayment > 0 ? totalPayment : 0).toLocaleString('en-IN'); document.getElementById('calcResultBox').classList.remove('hidden'); } catch (err) { showToast("Calculation Error", "error"); } };
    </script>
</body>
</html>
