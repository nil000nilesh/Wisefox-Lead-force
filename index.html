<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wisefox LeadApp Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .input-field:focus { border-color: #4F46E5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-enter { animation: slideDown 0.3s ease-out forwards; }
        .modern-bg { background-image: radial-gradient(circle at top right, #e0e7ff, transparent 40%), radial-gradient(circle at bottom left, #ede9fe, transparent 40%); }
    </style>
</head>
<body oncontextmenu="return false" class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex justify-center items-center relative modern-bg">
    
    <script>
        document.onkeydown = function(e) {
            if(event.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        }
    </script>

    <div id="toast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] px-5 py-2.5 rounded-full shadow-xl text-sm font-semibold text-white flex items-center gap-2 min-w-[200px] justify-center">
        <i id="toastIcon" class="fa-solid fa-circle-check"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <div class="w-full max-w-md h-full sm:h-[90vh] sm:rounded-3xl bg-white/95 backdrop-blur-xl shadow-2xl relative flex flex-col overflow-hidden sm:border border-white">
        
        <div class="bg-gradient-to-r from-indigo-600 to-violet-700 text-white p-4 pt-6 shadow-md z-10 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-lg tracking-tight flex items-center gap-2">
                        <i class="fa-solid fa-fox text-xl"></i> Wisefox Pro
                    </h2>
                    <p class="text-[10px] text-indigo-200 opacity-90 tracking-wide mt-0.5" id="userRoleDisplay">Lead Management System</p>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="openNotifModal()" id="notifBtn" class="hidden relative bg-white/20 hover:bg-white/30 w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm text-sm">
                        <i class="fa-solid fa-bell text-white"></i>
                        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full hidden shadow-sm border border-indigo-600">0</span>
                    </button>
                    <button onclick="openCalcMenu()" id="innerCalcBtn" class="hidden bg-white/20 hover:bg-white/30 w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm text-sm">
                        <i class="fa-solid fa-calculator text-white"></i>
                    </button>
                    <button onclick="logout()" id="logoutBtn" class="hidden bg-red-500/80 hover:bg-red-500 w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm text-sm">
                        <i class="fa-solid fa-power-off text-white"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-4 relative">

            <div id="authBox" class="h-full flex flex-col justify-center items-center fade-in px-2">
                <div class="bg-white/70 backdrop-blur-md border border-white/80 p-7 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.06)] w-full max-w-sm text-center relative overflow-hidden">
                    <div class="w-16 h-16 bg-gradient-to-tr from-indigo-600 to-violet-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white text-3xl shadow-lg transform -rotate-3">
                        <i class="fa-solid fa-shield-halved rotate-3"></i>
                    </div>
                    <h3 id="authTitle" class="text-2xl font-extrabold text-slate-800 tracking-tight">Welcome Back</h3>
                    <p id="authSubtitle" class="text-xs text-slate-500 font-medium mt-1 mb-6">Sign in securely to your account</p>

                    <div class="space-y-3 relative z-10">
                        <div class="relative">
                            <i class="fa-solid fa-envelope absolute left-3.5 top-3.5 text-slate-400 text-sm"></i>
                            <input id="emailInput" type="email" placeholder="Email Address" class="input-field w-full border border-slate-200 bg-white/60 rounded-xl p-3 pl-10 text-sm focus:outline-none" />
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute left-3.5 top-3.5 text-slate-400 text-sm"></i>
                            <input id="passwordInput" type="password" placeholder="Password (Min 6 chars)" class="input-field w-full border border-slate-200 bg-white/60 rounded-xl p-3 pl-10 text-sm focus:outline-none" />
                        </div>
                        <button id="mainAuthBtn" onclick="handleEmailAuth()" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white font-bold py-3 rounded-xl shadow-md transition-all mt-2 text-sm">
                            Login
                        </button>

                        <div class="text-center text-[11px] text-slate-600 mt-3 font-medium">
                            <span id="authToggleText">Don't have an account?</span>
                            <button onclick="toggleAuthMode()" class="text-indigo-600 font-bold ml-1 hover:underline">Sign Up</button>
                        </div>

                        <div class="flex items-center my-4">
                            <div class="flex-grow border-t border-slate-200"></div><span class="px-3 text-slate-400 text-[10px] font-bold uppercase tracking-wider">Or</span><div class="flex-grow border-t border-slate-200"></div>
                        </div>

                        <button onclick="googleLogin()" class="w-full bg-white border border-slate-200 text-slate-700 font-bold py-3 rounded-xl shadow-sm hover:bg-slate-50 transition flex items-center justify-center gap-2 text-sm">
                            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4" alt="G"> Continue with Google
                        </button>
                    </div>
                </div>

                <div class="w-full max-w-sm flex gap-3 mt-5">
                    <button onclick="openCalcMenu()" class="flex-1 bg-slate-800 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-slate-900 transition flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-calculator"></i> Calculator
                    </button>
                    <button onclick="shareAppWhatsApp()" class="flex-1 bg-green-500 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-green-600 transition flex items-center justify-center gap-2 text-xs">
                        <i class="fa-brands fa-whatsapp text-lg"></i> Share App
                    </button>
                </div>
            </div>

            <div id="calcMenuPage" class="hidden h-full flex-col fade-in pb-2">
                <div class="flex items-center mb-6 border-b border-slate-200 pb-3">
                    <button onclick="closeCalcMenu()" class="text-slate-500 hover:text-indigo-600 transition mr-3">
                        <i class="fa-solid fa-arrow-left text-xl"></i>
                    </button>
                    <h3 class="text-xl font-bold text-slate-800">Financial Tools</h3>
                </div>
                
                <div class="space-y-4">
                    <button onclick="showRoiReference()" class="w-full bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-2xl shadow-sm border border-orange-200 hover:shadow-md transition text-left flex items-center gap-4 group">
                        <div class="w-12 h-12 bg-orange-500 text-white rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform shadow-sm">
                            <i class="fa-solid fa-percent"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-base">BoB ROI Chart</h4>
                            <p class="text-[10px] font-bold text-orange-600 mt-0.5 uppercase tracking-wide">Latest Car Loan Rates</p>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-orange-400"></i>
                    </button>

                    <button onclick="showCalcCategory('loan')" class="w-full bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md hover:border-indigo-200 transition text-left flex items-center gap-4 group">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-building-columns"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-base">Loan Calculator</h4>
                            <p class="text-xs text-slate-500 mt-0.5">EMI, Eligibility, ROI, Tenure</p>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-slate-300"></i>
                    </button>

                    <button onclick="showCalcCategory('fd')" class="w-full bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md hover:border-emerald-200 transition text-left flex items-center gap-4 group">
                        <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-piggy-bank"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-base">FD Calculator</h4>
                            <p class="text-xs text-slate-500 mt-0.5">Maturity Value & Target Principal</p>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-slate-300"></i>
                    </button>

                    <button onclick="showCalcCategory('rd')" class="w-full bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md hover:border-orange-200 transition text-left flex items-center gap-4 group">
                        <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-coins"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-base">RD Calculator</h4>
                            <p class="text-xs text-slate-500 mt-0.5">Recurring Deposit & Target Monthly</p>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-slate-300"></i>
                    </button>
                </div>
            </div>

            <div id="roiReferencePage" class="hidden h-full flex-col fade-in pb-2 relative">
                <div class="flex items-center mb-4 border-b border-slate-200 pb-3 sticky top-0 bg-white/90 backdrop-blur-sm z-10 pt-2">
                    <button onclick="closeRoiReference()" class="text-slate-500 hover:text-orange-500 transition mr-3">
                        <i class="fa-solid fa-arrow-left text-xl"></i>
                    </button>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">Car Loan ROI</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">W.E.F 05-02-2026</p>
                    </div>
                </div>

                <div class="overflow-y-auto flex-1 hide-scrollbar space-y-4 pb-10">
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-orange-50 text-orange-800 text-xs font-black p-3 text-center border-b border-orange-100 tracking-wide">
                            CAR LOAN TO INDIVIDUALS (FLOATING)
                        </div>
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-[10px] text-slate-500 uppercase">
                                    <th class="p-2.5 border-b border-slate-200 pl-4">CIBIL Score</th>
                                    <th class="p-2.5 border-b border-slate-200 text-center">With LP*</th>
                                    <th class="p-2.5 border-b border-slate-200 text-center">W/O LP</th>
                                </tr>
                            </thead>
                            <tbody class="text-[11px] font-semibold text-slate-700">
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4 font-bold text-slate-800">771 & Above</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">7.60%</td><td class="p-2.5 text-center">7.65%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4 font-bold text-slate-800">751 to 770</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">7.65%</td><td class="p-2.5 text-center">7.70%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4 font-bold text-slate-800">726 to 750</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">8.00%</td><td class="p-2.5 text-center">8.05%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4 font-bold text-slate-800">701 to 725</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">8.65%</td><td class="p-2.5 text-center">8.70%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4 font-bold text-slate-800">(-1) & GMI > 40k</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">8.20%</td><td class="p-2.5 text-center">8.25%</td></tr>
                                <tr><td class="p-2.5 pl-4 font-bold text-slate-800">(-1) & GMI < 40k</td><td class="p-2.5 text-center text-emerald-600 bg-emerald-50/50">8.75%</td><td class="p-2.5 text-center">8.80%</td></tr>
                            </tbody>
                        </table>
                        <div class="bg-slate-50 text-[9px] text-slate-400 p-2 text-center border-t border-slate-100 italic">* LP = Loan Protection</div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-blue-50 text-blue-800 text-xs font-black p-3 text-center border-b border-blue-100 tracking-wide">
                            CAR LOAN TO CORPORATES
                        </div>
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-[10px] text-slate-500 uppercase">
                                    <th class="p-2.5 border-b border-slate-200 pl-4">CIBIL MSME Rank</th>
                                    <th class="p-2.5 border-b border-slate-200 text-center">Floating</th>
                                    <th class="p-2.5 border-b border-slate-200 text-center">Fixed</th>
                                </tr>
                            </thead>
                            <tbody class="text-[11px] font-semibold text-slate-700">
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4">CMR1, CMR2 & CMR3</td><td class="p-2.5 text-center text-emerald-600 font-bold bg-emerald-50/50">7.60%</td><td class="p-2.5 text-center">8.60%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4">CMR4</td><td class="p-2.5 text-center text-emerald-600 font-bold bg-emerald-50/50">7.90%</td><td class="p-2.5 text-center">8.75%</td></tr>
                                <tr class="border-b border-slate-100"><td class="p-2.5 pl-4">UNRATED (New)</td><td class="p-2.5 text-center text-emerald-600 font-bold bg-emerald-50/50">7.90%</td><td class="p-2.5 text-center">8.75%</td></tr>
                                <tr><td class="p-2.5 pl-4">Others (CMR5 & Below)</td><td class="p-2.5 text-center text-emerald-600 font-bold bg-emerald-50/50">8.40%</td><td class="p-2.5 text-center">9.25%</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-600 to-violet-700 border border-indigo-500 rounded-2xl p-4 shadow-md text-white relative overflow-hidden">
                        <div class="absolute -right-5 -top-5 opacity-10"><i class="fa-solid fa-gift text-7xl"></i></div>
                        <h4 class="text-xs font-black text-indigo-200 mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-tags"></i> Special Concessions</h4>
                        <ul class="text-[11px] text-white space-y-2.5 font-medium relative z-10">
                            <li class="flex justify-between items-center bg-white/10 p-2 rounded-lg"><span>Existing Home Loan Customer</span> <span class="font-black text-amber-300 text-sm">-0.25%</span></li>
                            <li class="flex justify-between items-center bg-white/10 p-2 rounded-lg"><span>Electric Vehicle (EV)</span> <span class="font-black text-amber-300 text-sm">-0.15%</span></li>
                            <li class="flex justify-between items-center bg-white/10 p-2 rounded-lg"><span>Min 50% Liquid Security</span> <span class="font-black text-amber-300 text-sm">-0.50%</span></li>
                        </ul>
                        <div class="mt-3 text-[9px] text-indigo-300 italic text-center font-bold">
                            *Subject to Minimum ROI of 7.90% (Floating Option)
                        </div>
                    </div>

                    <div class="bg-slate-100 rounded-xl p-4 border border-slate-200 text-[10px] text-slate-600">
                        <div class="flex justify-between mb-1.5"><span class="font-bold">Max Funding:</span> <span>90% of On-Road Price</span></div>
                        <div class="flex justify-between mb-1.5"><span class="font-bold">Max Tenure:</span> <span>84 Months</span></div>
                        <div class="flex justify-between"><span class="font-bold">Min Tenure (Fixed Only):</span> <span>37 Months</span></div>
                    </div>
                </div>
            </div>


            <div id="calculatorPage" class="hidden h-full flex-col fade-in pb-2">
                <div class="flex items-center mb-3 border-b border-slate-200 pb-2">
                    <button onclick="goBackToCalcMenu()" class="text-slate-500 hover:text-indigo-600 transition mr-2"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                    <h3 id="activeCalcTitle" class="text-lg font-bold text-slate-800">Smart Calculator</h3>
                </div>
                <div class="space-y-2.5">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">What to calculate?</label>
                        <select id="calcMode" onchange="updateCalcUI()" class="w-full border border-slate-300 rounded-lg p-2 mt-0.5 bg-white focus:outline-none font-medium text-indigo-700 text-sm shadow-sm">
                        </select>
                    </div>
                    <div id="calcInputAmount" class="relative">
                        <label id="lblCalcAmount" class="text-[11px] font-semibold text-slate-600">Amount (â‚¹)</label>
                        <input id="cAmount" type="number" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" />
                    </div>
                    <div id="calcInputEMI" class="relative hidden">
                        <label id="lblCalcEMI" class="text-[11px] font-semibold text-slate-600">Monthly EMI (â‚¹)</label>
                        <input id="cEmi" type="number" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" />
                    </div>
                    <div id="calcInputROI" class="relative">
                        <label class="text-[11px] font-semibold text-slate-600">Rate of Interest (% p.a.)</label>
                        <input id="cRoi" type="number" step="0.1" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2 mt-0.5 text-sm" />
                    </div>
                    <div id="calcInputTerm" class="relative">
                        <label class="text-[11px] font-semibold text-slate-600">Tenure / Time</label>
                        <div class="flex mt-0.5 gap-2">
                            <input id="cTerm" type="number" class="input-field flex-1 border border-slate-200 bg-slate-50 rounded-lg p-2 text-sm" placeholder="e.g. 5" />
                            <select id="cTermType" class="border border-slate-200 bg-white rounded-lg p-2 text-sm font-medium text-slate-700 w-24 outline-none shadow-sm">
                                <option value="years">Years</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="performCalculation()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 rounded-xl shadow-lg mt-3 text-sm transition">
                        Calculate Results
                    </button>

                    <div id="calcResultBox" class="hidden mt-4 bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                        <div class="text-center mb-3 border-b border-slate-600 pb-3">
                            <p class="text-[10px] text-emerald-400 font-bold uppercase tracking-wider mb-0.5" id="resMainTitle">Your Result</p>
                            <h2 class="text-2xl font-black" id="resMainValue">â‚¹0</h2>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-slate-400" id="resLbl1">Principal Amount</span><span class="font-semibold" id="resPrincipal">â‚¹0</span></div>
                            <div class="flex justify-between"><span class="text-slate-400" id="resLbl2">Total Interest</span><span class="font-semibold text-amber-400" id="resInterest">â‚¹0</span></div>
                            <div class="flex justify-between border-t border-slate-600 pt-2"><span class="text-slate-300 font-bold" id="resLbl3">Total Payment</span><span class="font-bold text-emerald-400" id="resTotal">â‚¹0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signupBox" class="hidden h-full flex flex-col justify-center fade-in">
                <h3 class="text-lg font-bold mb-1 text-slate-800">Complete Profile</h3>
                <p class="text-xs text-slate-500 mb-4">Please provide your details to continue.</p>
                <div class="space-y-3">
                    <input id="profileName" placeholder="Full Name" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm focus:outline-none" />
                    <input id="mobile" type="number" placeholder="Mobile Number (10 digits)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm focus:outline-none" />
                    <input id="location" placeholder="Location / City" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-2.5 text-sm focus:outline-none" />
                    <button onclick="completeSignup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl shadow-md mt-2 text-sm">Save & Continue</button>
                </div>
            </div>

            <div id="app" class="hidden pb-16 fade-in">
                
                <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-4">
                    <div>
                        <h2 id="greetingMsg" class="font-bold text-slate-800 text-sm">Welcome!</h2>
                        <p id="liveClock" class="text-[10px] text-slate-500 font-medium mt-0.5"><i class="fa-regular fa-clock"></i> --:--</p>
                    </div>
                    <div class="w-9 h-9 bg-gradient-to-tr from-indigo-100 to-violet-200 rounded-full flex items-center justify-center text-indigo-700 font-black text-sm shadow-sm border border-indigo-200" id="userInitial">U</div>
                </div>

                <div class="bg-slate-200/60 p-1 rounded-xl flex mb-4 sticky top-0 backdrop-blur-md z-10 border border-slate-200">
                    <button onclick="showPage('leads')" id="tab-leads" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-indigo-600 shadow-sm">Leads</button>
                    <button onclick="showPage('users')" id="tab-users" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-indigo-600 transition-all">Team / Profile</button>
                </div>

                <div id="leadsPage">
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-indigo-50 border border-indigo-100 p-2.5 rounded-xl text-center shadow-sm">
                            <div class="text-[10px] text-indigo-500 font-bold uppercase mb-0.5">Leads</div>
                            <div class="text-xl font-black text-indigo-700" id="dashCount">0</div>
                        </div>
                        <div class="bg-emerald-50 border border-emerald-100 p-2.5 rounded-xl text-center shadow-sm col-span-2">
                            <div class="text-[10px] text-emerald-600 font-bold uppercase mb-0.5">Total Business</div>
                            <div class="text-xl font-black text-emerald-700" id="dashAmount">â‚¹0</div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="openModal()" class="flex-1 bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-2 rounded-xl shadow-md font-semibold flex items-center justify-center hover:shadow-lg transition text-xs">
                            <i class="fa-solid fa-plus-circle mr-1.5"></i> Add Lead
                        </button>
                        <select id="sortSelect" onchange="changeSort()" class="bg-white border border-slate-200 text-slate-600 text-[11px] rounded-xl px-2 py-2 focus:outline-none shadow-sm font-semibold w-24">
                            <option value="new">Newest</option>
                            <option value="amtHigh">Amt: High</option>
                            <option value="amtLow">Amt: Low</option>
                        </select>
                        <button onclick="exportCSV()" id="exportBtn" class="hidden bg-slate-800 text-white px-3 py-2 rounded-xl shadow-md hover:bg-slate-900 transition text-[11px] font-semibold">
                            <i class="fa-solid fa-file-csv"></i>
                        </button>
                    </div>

                    <div id="list" class="space-y-3 pb-10"></div>
                </div>

                <div id="usersPage" class="hidden space-y-4">
                    <div id="myProfilePanel" class="mb-4"></div>
                    
                    <div id="dsaPanel" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 text-xs uppercase tracking-wide">Link New Sub-DSA</h3>
                        <div class="space-y-2.5">
                            <input id="subMobile" type="number" placeholder="Enter New User's Mobile (10 digits)" class="input-field w-full border border-slate-200 rounded-lg p-2.5 text-xs focus:outline-none focus:border-indigo-500" />
                            <button onclick="createSubDSA()" class="w-full bg-blue-600 hover:bg-blue-700 transition text-white py-2.5 rounded-lg text-xs font-bold shadow">Link Sub-DSA</button>
                        </div>
                    </div>
                    
                    <div id="mySubList" class="hidden"><h3 class="font-bold text-slate-700 mb-2 text-sm ml-1">My Team</h3><div id="subList" class="space-y-2"></div></div>
                    <div id="adminPanel" class="hidden"><h3 class="font-bold text-slate-700 mb-2 text-sm ml-1">All Users Directory</h3><div id="userList" class="space-y-2"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="notifModal" class="hidden fixed inset-0 z-50 flex items-start justify-center bg-black/60 backdrop-blur-sm p-4 pt-20">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl fade-in">
            <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-3">
                <h3 class="font-bold text-md text-slate-800"><i class="fa-solid fa-bell text-indigo-500 mr-2"></i> Pending Actions</h3>
                <div class="flex items-center gap-2.5">
                    <button onclick="clearNotifications()" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded shadow-sm font-bold transition border border-slate-200">Clear All</button>
                    <button onclick="closeNotifModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
            </div>
            <div id="notifList" class="space-y-2 max-h-[60vh] overflow-y-auto hide-scrollbar"></div>
        </div>
    </div>

    <div id="queryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl fade-in">
            <h3 class="font-bold text-md mb-1 text-slate-800">Ask a Query via WhatsApp</h3>
            <p class="text-[10px] text-slate-500 mb-3">Your message will be sent to WhatsApp with Lead Details.</p>
            <textarea id="queryText" rows="3" placeholder="Type your query regarding this lead..." class="w-full border border-slate-300 p-3 rounded-xl mb-4 bg-slate-50 text-sm focus:outline-none focus:border-indigo-500"></textarea>
            <div class="flex gap-2">
                <button onclick="closeQueryModal()" class="flex-1 text-slate-500 text-sm font-semibold hover:bg-slate-100 py-2 rounded-xl">Cancel</button>
                <button onclick="submitQuery()" class="flex-1 bg-green-500 text-white py-2 rounded-xl text-sm font-bold hover:bg-green-600 shadow flex items-center justify-center gap-1.5"><i class="fa-brands fa-whatsapp text-base"></i> Share</button>
            </div>
        </div>
    </div>
    
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">New Lead Details</h3>
            <div class="space-y-3">
                <input id="leadName" placeholder="Client Name" class="w-full border border-slate-300 p-2.5 rounded-xl bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <input id="leadPhone" type="number" placeholder="Mobile No (10 Digits)" class="w-full border border-slate-300 p-2.5 rounded-xl bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <textarea id="leadAddress" placeholder="Full Address / City" rows="2" class="w-full border border-slate-300 p-2.5 rounded-xl bg-slate-50 text-sm focus:outline-none focus:border-indigo-500"></textarea>
                <select id="type" class="w-full border border-slate-300 p-2.5 rounded-xl bg-slate-50 text-sm focus:outline-none focus:border-indigo-500">
    <option>Personal Loan</option>
    <option>Home Loan</option>
    <option>Business Loan</option>
    <option>Auto Loan</option>
    <option>KCC</option>
    <option>Education Loan</option>
    <option>Mortgage Loan</option>
</select>
                <input id="leadAmount" placeholder="Amount Required (â‚¹)" type="number" class="w-full border border-slate-300 p-2.5 rounded-xl bg-slate-50 text-sm focus:outline-none focus:border-indigo-500" />
                <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
                    <button onclick="closeModal()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl text-sm font-bold">Cancel</button>
                    <button id="submitLeadBtn" onclick="saveLead()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl shadow hover:bg-indigo-700 text-sm font-bold transition">Save Lead</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-md mb-3">Update Status</h3>
            <select id="newStatus" class="w-full border p-3 rounded-xl mb-4 bg-slate-50 text-sm focus:outline-none">
                <option>Pending</option><option>Contacted</option><option>In Process</option><option>Sanctioned</option><option>Disbursed</option><option>Rejected</option>
            </select>
            <div class="flex gap-2">
                <button onclick="closeStatusModal()" class="flex-1 text-slate-500 text-sm font-bold">Cancel</button>
                <button onclick="saveStatus()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl text-sm font-bold">Update</button>
            </div>
        </div>
    </div>

    <div id="subDSAModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-md mb-1 text-slate-800">Assign Parent DSA</h3>
            <label class="text-[10px] font-bold text-slate-600 uppercase">Select DSA</label>
            <select id="modalDSASelect" class="w-full border border-slate-200 bg-slate-50 rounded-xl p-2.5 mt-1 mb-4 text-sm focus:outline-none"><option value="">-- Choose DSA --</option></select>
            <div class="flex gap-2">
                <button onclick="closeSubDSAModal()" class="flex-1 text-slate-500 py-2 rounded-xl text-sm font-bold">Cancel</button>
                <button onclick="confirmSubDSALink()" class="flex-1 bg-blue-600 text-white py-2 rounded-xl shadow text-sm font-bold">Link Now</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E", authDomain: "wisfox-lead-app.firebaseapp.com", projectId: "wisfox-lead-app" };
        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const db = getFirestore(appFirebase);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        window.mySubDSAEmails = [];
        window.latestLeadsSnap = null;
        window.processedLeads = []; 
        window.allUsers = []; 
        window.currentSort = 'new';
        window.currentQueryLead = null; 

        // --- SECURITY & HELPERS ---
        window.escapeHTML = (str) => {
            if (!str) return '';
            return str.toString().replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag]));
        };

        window.generate5DigitId = (str) => {
            if(!str) return '00000'; let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            return 10000 + (Math.abs(hash) % 90000); 
        };

        window.speakText = (message) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const speech = new SpeechSynthesisUtterance(message);
                speech.lang = 'hi-IN'; 
                speech.rate = 1;
                speech.pitch = 1;
                window.speechSynthesis.speak(speech);
            }
        };

        window.triggerCelebration = () => {
            if(typeof confetti !== 'undefined'){
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6 },
                    colors: ['#FFC0CB', '#FF69B4', '#4F46E5', '#10B981', '#F59E0B'] 
                });
            }
        };

        window.startLiveClock = () => {
            const updateClock = () => {
                if(!currentUser) return;
                const now = new Date(); const hours = now.getHours();
                let greeting = 'Good Night'; let icon = 'ðŸŒ™';
                if (hours >= 5 && hours < 12) { greeting = 'Good Morning'; icon = 'â˜€ï¸'; }
                else if (hours >= 12 && hours < 17) { greeting = 'Good Afternoon'; icon = 'ðŸŒ¤ï¸'; }
                else if (hours >= 17 && hours < 21) { greeting = 'Good Evening'; icon = 'ðŸŒ†'; }
                const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const firstName = window.escapeHTML(currentUser.name ? currentUser.name.split(' ')[0] : 'User');
                document.getElementById('greetingMsg').innerHTML = `${greeting}, ${firstName} ${icon}`;
                document.getElementById('liveClock').innerHTML = `<i class="fa-regular fa-clock"></i> ${timeString}`;
                document.getElementById('userInitial').innerText = firstName.charAt(0).toUpperCase();
            };
            updateClock(); setInterval(updateClock, 60000); 
        };

        window.showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast'); const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg;
            toast.className = `toast-enter fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] px-5 py-2.5 rounded-full shadow-xl text-sm font-semibold text-white flex items-center gap-2 min-w-[200px] justify-center ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            icon.className = type === 'success' ? 'fa-solid fa-circle-check' : 'fa-solid fa-circle-exclamation';
            toast.classList.remove('hidden'); setTimeout(() => { toast.classList.add('hidden'); }, 3500);
        };

        window.shareAppWhatsApp = () => {
            const appUrl = window.location.href.split('?')[0]; 
            const text = `*Wisefox LeadApp Pro* ðŸš€%0A%0AThe Ultimate CRM for Loan Agents! Manage your leads, calculate EMI, FD, RD, and grow your team smartly.%0A%0A*Join now by clicking here:* %0A${appUrl}`;
            window.open(`https://wa.me/?text=${text}`, '_blank');
        };

        window.openNotifModal = () => document.getElementById('notifModal').classList.remove('hidden');
        window.closeNotifModal = () => document.getElementById('notifModal').classList.add('hidden');
        window.goToUser = () => { window.closeNotifModal(); window.showPage('users'); };
        window.goToLead = () => { window.closeNotifModal(); window.showPage('leads'); };

        window.clearNotifications = () => {
            let activeIds = [];
            window.allUsers.forEach(u => { if (u.role === 'new') activeIds.push('usr_' + u.id); });
            window.processedLeads.forEach(l => {
                let isTargetLead = false;
                if (currentUser.role === 'admin') isTargetLead = true;
                if (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail)) isTargetLead = true;
                if(isTargetLead) {
                    if (l.status === 'Pending') activeIds.push('ld_pend_' + l.id);
                    if (l.hasQuery) activeIds.push('ld_query_' + l.id);
                }
            });
            let dismissed = JSON.parse(localStorage.getItem('dismissedNotifs') || '[]');
            dismissed = [...new Set([...dismissed, ...activeIds])]; 
            localStorage.setItem('dismissedNotifs', JSON.stringify(dismissed));
            window.updateNotifications();
            showToast('Notifications Cleared!');
        };

        window.updateNotifications = () => {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'dsa')) return;
            const notifList = document.getElementById('notifList'); const badge = document.getElementById('notifBadge');
            let dismissedNotifs = JSON.parse(localStorage.getItem('dismissedNotifs') || '[]');
            notifList.innerHTML = ''; let count = 0;

            if (currentUser.role === 'admin') {
                window.allUsers.forEach(u => {
                    if (u.role === 'new' && !dismissedNotifs.includes('usr_' + u.id)) {
                        count++; const uid = `USR-${window.generate5DigitId(u.id)}`;
                        notifList.innerHTML += `<div onclick="goToUser()" class="bg-blue-50 border border-blue-100 p-3 rounded-xl cursor-pointer hover:bg-blue-100 transition flex items-center justify-between mb-2 shadow-sm"><div><div class="text-[9px] text-blue-600 font-bold uppercase mb-0.5"><i class="fa-solid fa-user-plus mr-1"></i> New Registration</div><div class="font-semibold text-sm text-slate-800">${window.escapeHTML(u.name)} <span class="text-[9px] text-slate-500 font-mono ml-1">#${uid}</span></div></div><i class="fa-solid fa-chevron-right text-blue-400"></i></div>`;
                    }
                });
            }

            window.processedLeads.forEach(l => {
                const lid = `LD-${window.generate5DigitId(l.id)}`;
                let isTargetLead = false;
                if (currentUser.role === 'admin') isTargetLead = true;
                if (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail)) isTargetLead = true;

                if (isTargetLead) {
                    if (l.status === 'Pending' && !dismissedNotifs.includes('ld_pend_' + l.id)) {
                        count++;
                        notifList.innerHTML += `<div onclick="goToLead()" class="bg-amber-50 border border-amber-100 p-3 rounded-xl cursor-pointer hover:bg-amber-100 transition flex items-center justify-between mb-2 shadow-sm"><div><div class="text-[9px] text-amber-600 font-bold uppercase mb-0.5"><i class="fa-solid fa-file-invoice-dollar mr-1"></i> Lead Pending</div><div class="font-semibold text-sm text-slate-800">${window.escapeHTML(l.name)} <span class="text-[9px] text-slate-500 font-mono ml-1">#${lid}</span></div><div class="text-[10px] text-slate-600 mt-0.5 font-medium">â‚¹${Number(l.amount).toLocaleString('en-IN')}</div></div><i class="fa-solid fa-chevron-right text-amber-400"></i></div>`;
                    }
                    if (l.hasQuery && !dismissedNotifs.includes('ld_query_' + l.id)) {
                        count++;
                        notifList.innerHTML += `<div onclick="goToLead()" class="bg-red-50 border border-red-200 p-3 rounded-xl cursor-pointer hover:bg-red-100 transition flex items-center justify-between mb-2 shadow-sm"><div><div class="text-[9px] text-red-600 font-bold uppercase mb-0.5"><i class="fa-solid fa-circle-question mr-1"></i> New Query</div><div class="font-semibold text-sm text-slate-800">${window.escapeHTML(l.name)} <span class="text-[9px] text-slate-500 font-mono ml-1">#${lid}</span></div><div class="text-[10px] text-slate-600 mt-0.5 italic truncate w-48">"${window.escapeHTML(l.queryMessage)}"</div></div><i class="fa-solid fa-chevron-right text-red-400"></i></div>`;
                    }
                }
            });

            if (count > 0) { badge.innerText = count > 9 ? '9+' : count; badge.classList.remove('hidden'); } 
            else { badge.classList.add('hidden'); notifList.innerHTML = '<div class="text-center text-xs text-slate-400 py-6 italic">No pending actions</div>'; }
        };

        window.openQueryModal = (id) => { 
            window.currentQueryLead = window.processedLeads.find(l => l.id === id); 
            document.getElementById('queryText').value = ''; 
            document.getElementById('queryModal').classList.remove('hidden'); 
        };
        
        window.closeQueryModal = () => { 
            window.currentQueryLead = null; 
            document.getElementById('queryModal').classList.add('hidden'); 
        };
        
        window.submitQuery = () => {
            const text = document.getElementById('queryText').value.trim();
            if(!text) return showToast('Please type a query first!', 'error');
            
            if(window.currentQueryLead) {
                const l = window.currentQueryLead;
                const leadIdShort = `LD-${window.generate5DigitId(l.id)}`;
                
                const waText = `*New Query Regarding Lead* â“\n\n*My Query:* ${text}\n\n*--- Lead Details ---*\n*Lead ID:* #${leadIdShort}\n*Name:* ${l.name}\n*Phone:* ${l.phone}\n*Location:* ${l.address || 'N/A'}\n*Loan Type:* ${l.type}\n*Amount:* â‚¹${Number(l.amount).toLocaleString('en-IN')}\n*Status:* ${l.status}\n*Added By:* ${l.agentName}\n\n_Sent via Wisefox LeadApp Pro_`;

                window.open(`https://wa.me/?text=${encodeURIComponent(waText)}`, '_blank');
                
                showToast('Drafting WhatsApp Message...', 'success');
                window.closeQueryModal();
            }
        };

        // --- AUTH ---
        let isLoginMode = true;
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? 'Welcome Back' : 'Create Account';
            document.getElementById('authSubtitle').innerText = isLoginMode ? 'Sign in securely to your account' : 'Sign up to get started securely';
            document.getElementById('mainAuthBtn').innerText = isLoginMode ? 'Login' : 'Sign Up';
            document.getElementById('authToggleText').innerText = isLoginMode ? "Already have an account?" : "Don't have an account?";
            event.target.innerText = isLoginMode ? 'Sign Up' : 'Login';
        };

        window.handleEmailAuth = async () => {
            const email = document.getElementById('emailInput').value.trim(); const password = document.getElementById('passwordInput').value.trim();
            if(!email || !password) return showToast("Enter Email and Password!", 'error');
            if(password.length < 6) return showToast("Password min 6 chars!", 'error');
            try { let result = isLoginMode ? await signInWithEmailAndPassword(auth, email, password) : await createUserWithEmailAndPassword(auth, email, password); await handleLogin(result.user); } 
            catch (error) { showToast(error.message.split('/')[1] || "Auth Failed", 'error'); }
        };

        window.googleLogin = async () => { try { const result = await signInWithPopup(auth, provider); await handleLogin(result.user); } catch (error) { signInWithRedirect(auth, provider); } };

        async function handleLogin(user){
            const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
            if(snap.empty){
                document.getElementById('authBox').classList.add('hidden'); document.getElementById('signupBox').classList.remove('hidden');
                if(user.displayName) document.getElementById('profileName').value = user.displayName;
                window.tempUser = user; return;
            }
            currentUser = snap.docs[0].data(); currentUser.id = snap.docs[0].id; 
            showToast(`Welcome back, ${currentUser.name}!`); 
            
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : 'User';
            window.speakText(`${firstName}, Wisefox app mein aapka swagat hai. Aasha karte hain aapka din achha ja raha hoga.`);

            startApp();
        }

        window.completeSignup = async () => {
            const user = window.tempUser;
            const nameVal = document.getElementById('profileName').value.trim() || user.displayName || 'User';
            const mobileVal = document.getElementById('mobile').value.trim();
            const locationVal = document.getElementById('location').value.trim();
            if(!nameVal || !mobileVal || !locationVal) return showToast('Fill all details!', 'error');
            if(mobileVal.length !== 10) return showToast('Mobile must be 10 digits!', 'error');

            const role = user.email === 'nil000nilesh@gmail.com' ? 'admin' : 'new';
            const snap = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
            if(!snap.empty){
                const existingId = snap.docs[0].id; await updateDoc(doc(db,'users',existingId), { name: window.escapeHTML(nameVal), mobile: window.escapeHTML(mobileVal), location: window.escapeHTML(locationVal) });
                currentUser = snap.docs[0].data(); currentUser.id = existingId;
            } else {
                await setDoc(doc(db,'users',user.uid), { name: window.escapeHTML(nameVal), email: user.email, mobile: window.escapeHTML(mobileVal), location: window.escapeHTML(locationVal), role, parentEmail: null, blocked: false });
                currentUser = {name: nameVal, email: user.email, role, mobile: mobileVal, location: locationVal}; currentUser.id = user.uid; 
            }
            document.getElementById('signupBox').classList.add('hidden'); showToast('Account Created Successfully!'); 
            
            const firstName = nameVal.split(' ')[0];
            window.speakText(`${firstName}, Wisefox app mein aapka swagat hai. Aasha karte hain aapka din achha ja raha hoga.`);

            startApp();
        };

        function renderMyProfile() {
            const uid = `USR-${window.generate5DigitId(currentUser.id)}`;
            document.getElementById('myProfilePanel').innerHTML = `
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 opacity-20"><i class="fa-solid fa-address-card text-9xl"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div><h3 class="font-bold text-[10px] text-indigo-200 uppercase tracking-wider mb-1">My Profile</h3><div class="font-black text-xl">${window.escapeHTML(currentUser.name)}</div><div class="text-xs font-mono bg-black/20 px-2.5 py-1 rounded-md inline-block mt-1.5 mb-4">ID: #${uid}</div></div>
                        <span class="text-[10px] bg-white text-indigo-700 font-extrabold px-3 py-1.5 rounded-lg shadow-sm uppercase">${currentUser.role}</span>
                    </div>
                    <div class="text-sm space-y-2 opacity-95 relative z-10 font-medium">
                        <div><i class="fa-solid fa-phone w-5 text-center text-indigo-200"></i> ${window.escapeHTML(currentUser.mobile)}</div>
                        <div><i class="fa-solid fa-envelope w-5 text-center text-indigo-200"></i> ${window.escapeHTML(currentUser.email)}</div>
                        <div><i class="fa-solid fa-map-pin w-5 text-center text-indigo-200"></i> ${window.escapeHTML(currentUser.location) || 'N/A'}</div>
                    </div>
                    <button onclick="shareMyProfile()" class="absolute bottom-5 right-5 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md transition flex items-center gap-1.5 z-10"><i class="fa-brands fa-whatsapp text-base"></i> Share</button>
                </div>`;
        }
        
        window.shareMyProfile = () => {
            const uid = `USR-${window.generate5DigitId(currentUser.id)}`;
            const text = `*Wisefox Profile Details* ðŸ¦Š\n\n*Name:* ${currentUser.name}\n*User ID:* #${uid}\n*Role:* ${currentUser.role.toUpperCase()}\n*Mobile:* ${currentUser.mobile}\n*Location:* ${currentUser.location}\n\n_Shared via Wisefox LeadApp Pro_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.shareOnWhatsApp = (leadId, name, phone, address, type, amount, status, agentName) => {
            const text = `*Wisefox Lead Details* ðŸ¦Š\n\n*Lead ID:* #${leadId}\n*Name:* ${name}\n*Phone:* ${phone}\n*Location:* ${address}\n*Loan Type:* ${type}\n*Amount:* â‚¹${Number(amount).toLocaleString('en-IN')}\n*Status:* ${status}\n*Added By:* ${agentName}\n\n_Sent via Wisefox LeadApp Pro_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        function startApp(){
            document.getElementById('authBox').classList.add('hidden'); document.body.classList.remove('modern-bg'); document.getElementById('app').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden'); document.getElementById('innerCalcBtn').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = `Role: ${currentUser.role.toUpperCase()}`;
            
            if(currentUser.role === 'admin' || currentUser.role === 'dsa') {
                document.getElementById('notifBtn').classList.remove('hidden'); 
                document.getElementById('exportBtn').classList.remove('hidden');
            }
            window.startLiveClock(); renderMyProfile(); loadLeads();
            if(currentUser.role === 'admin'){ document.getElementById('adminPanel').classList.remove('hidden'); loadNewUsers(); }
            if(currentUser.role === 'dsa'){ document.getElementById('dsaPanel').classList.remove('hidden'); document.getElementById('mySubList').classList.remove('hidden'); loadMySubDSA(); }
        }

        window.logout = () => signOut(auth).then(() => location.reload());
        window.changeSort = () => { window.currentSort = document.getElementById('sortSelect').value; renderLeadsUI(); };

        window.exportCSV = () => {
            if(window.processedLeads.length === 0) return showToast("No leads to export!", "error");
            let csv = "Lead ID,Name,Phone,Address,Type,Amount,Status,Agent\n";
            window.processedLeads.forEach(l => { const leadIdShort = `LD-${window.generate5DigitId(l.id)}`; csv += `"${leadIdShort}","${l.name}","${l.phone}","${l.address}","${l.type}","${l.amount}","${l.status}","${l.agentName}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Wisefox_Leads.csv'; a.click(); showToast("Report Exported Successfully!");
        };

        function renderLeadsUI() {
            const list = document.getElementById('list'); list.innerHTML = '';
            let totalAmount = 0; let totalCount = window.processedLeads.length;

            let sortedArr = [...window.processedLeads];
            if(window.currentSort === 'amtHigh') sortedArr.sort((a,b) => b.amount - a.amount);
            else if(window.currentSort === 'amtLow') sortedArr.sort((a,b) => a.amount - b.amount);
            else sortedArr.sort((a,b) => b.created - a.created); 

            sortedArr.forEach(l => {
                totalAmount += Number(l.amount);
                const leadIdShort = `LD-${window.generate5DigitId(l.id)}`;
                const statusClass = l.status === 'Disbursed' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : l.status === 'Rejected' ? 'bg-red-100 text-red-700 border-red-200' : l.status === 'Sanctioned' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200';
                
                let waBtn = `<button onclick="shareOnWhatsApp('${leadIdShort}', '${window.escapeHTML(l.name)}', '${window.escapeHTML(l.phone)}', '${window.escapeHTML(l.address)}', '${window.escapeHTML(l.type)}', '${l.amount}', '${l.status}', '${window.escapeHTML(l.agentName)}')" class="text-[12px] text-green-600 bg-green-50 px-2.5 py-1.5 rounded-lg ml-1 hover:bg-green-100 shadow-sm"><i class="fa-brands fa-whatsapp text-sm"></i></button>`;
                let queryBtn = (currentUser.role === 'subdsa' || currentUser.role === 'new') ? `<button onclick="openQueryModal('${l.id}')" title="Ask a Query" class="text-[12px] text-orange-600 bg-orange-50 px-2.5 py-1.5 rounded-lg ml-1 hover:bg-orange-100 shadow-sm"><i class="fa-solid fa-comment-dots text-sm"></i></button>` : '';
                let btn = (currentUser.role === 'dsa' || currentUser.role === 'admin') ? `<button onclick="openStatusModal('${l.id}','${l.status}')" class='text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg ml-1 hover:bg-indigo-100 shadow-sm'>Edit</button>` : '';
                let adminBtns = currentUser.role === 'admin' ? `<button onclick="deleteLead('${l.id}')" class='text-[10px] text-red-500 bg-red-50 px-2.5 py-1.5 rounded-lg ml-1 hover:bg-red-100 shadow-sm'><i class="fa-solid fa-trash"></i></button>` : '';
                
                let queryDisplay = '';
                if (l.hasQuery) {
                    let resolveBtn = (currentUser.role === 'admin' || currentUser.role === 'dsa') ? `<button onclick="resolveQuery('${l.id}')" class="ml-2 text-indigo-700 bg-indigo-100 px-2 py-1 rounded shadow-sm hover:bg-indigo-200 font-bold text-[9px]">Resolve <i class="fa-solid fa-check"></i></button>` : '';
                    queryDisplay = `<div class="mt-2 bg-red-50 border border-red-100 text-red-700 text-xs p-2 rounded-lg flex justify-between items-center"><span class="italic font-medium"><i class="fa-solid fa-circle-question mr-1"></i> Q: ${window.escapeHTML(l.queryMessage)}</span> ${resolveBtn}</div>`;
                }

                list.innerHTML += `<div class='bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative mb-4'><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-800 text-base">${window.escapeHTML(l.name)} <span class="text-[10px] font-mono text-slate-400 font-medium ml-1 bg-slate-100 px-1.5 py-0.5 rounded">#${leadIdShort}</span></h4><span class="text-xs font-semibold text-slate-500">${window.escapeHTML(l.type)}</span></div><span class="text-[10px] px-2.5 py-1 rounded-full font-bold border ${statusClass}">${l.status||'Pending'}</span></div><div class="mb-3 space-y-1 bg-slate-50 p-2 rounded-xl border border-slate-100"><div class="text-xs text-slate-600 font-medium"><i class="fa-solid fa-phone text-slate-400 mr-2 w-3"></i> ${window.escapeHTML(l.phone)}</div><div class="text-xs text-slate-600 truncate font-medium"><i class="fa-solid fa-location-dot text-slate-400 mr-2 w-3"></i> ${window.escapeHTML(l.address) || 'NA'}</div></div>${queryDisplay}<div class="flex justify-between items-end mt-2 pt-3 border-t border-slate-100"><div><div class="text-base font-black text-slate-800">â‚¹${Number(l.amount).toLocaleString('en-IN')}</div><div class="text-[9px] text-indigo-700 font-bold bg-indigo-100 px-2 py-1 rounded mt-1 inline-block"><i class="fa-regular fa-user mr-1"></i> By: ${window.escapeHTML(l.agentName)}</div></div><div class="flex items-center">${waBtn} ${queryBtn} ${btn} ${adminBtns}</div></div></div>`;
            });
            document.getElementById('dashCount').innerText = totalCount;
            document.getElementById('dashAmount').innerText = "â‚¹" + (totalAmount >= 100000 ? (totalAmount/100000).toFixed(2) + "L" : totalAmount.toLocaleString('en-IN'));
        }

        function loadLeads(){
            onSnapshot(collection(db,'leads'), snap => {
                window.processedLeads = [];
                snap.forEach(d => {
                    const l = d.data(); l.id = d.id;
                    if(currentUser.role === 'admin' || l.agentEmail === currentUser.email || (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail))){
                        window.processedLeads.push(l);
                    }
                });
                renderLeadsUI(); window.updateNotifications(); 
            });
        }

        window.saveLead = async () => {
            if(currentUser && currentUser.role === 'new') return showToast('Access Denied! Wait for Admin to assign role.', 'error');
            const btn = document.getElementById('submitLeadBtn');
            const name = document.getElementById('leadName').value.trim(); const phone = document.getElementById('leadPhone').value.trim();
            const address = document.getElementById('leadAddress').value.trim(); const amount = document.getElementById('leadAmount').value.trim(); const type = document.getElementById('type').value;

            if(!name || !phone || !amount || !address) return showToast('Fill all fields!', 'error');
            if(phone.length !== 10) return showToast('Mobile must be 10 digits!', 'error');
            
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Saving...'; btn.classList.add('opacity-70', 'cursor-not-allowed');
            try {
                const userSnap = await getDocs(query(collection(db,'users'), where('email','==',currentUser.email)));
                if(!userSnap.empty && userSnap.docs[0].data().blocked) throw new Error('Blocked by Admin');
                await addDoc(collection(db,'leads'), { name: window.escapeHTML(name), phone: window.escapeHTML(phone), address: window.escapeHTML(address), type: window.escapeHTML(type), amount: Number(amount)||0, status: 'Pending', agentEmail: currentUser.email, agentName: currentUser.name || 'Unknown', created: Date.now(), hasQuery: false, queryMessage: '' });
                
                showToast('Lead Generated Successfully!'); 
                closeModal();
                document.getElementById('leadName').value=''; document.getElementById('leadPhone').value=''; document.getElementById('leadAddress').value=''; document.getElementById('leadAmount').value='';
                
                window.triggerCelebration();
                const cleanName = window.escapeHTML(name);
                window.speakText(`${cleanName} ki lead daalne ke liye aapka dhanyawad. Aapka din achha jaye.`);

            } catch(e) { showToast(e.message || 'Error saving lead', 'error'); } 
            finally { btn.disabled = false; btn.innerHTML = 'Save Lead'; btn.classList.remove('opacity-70', 'cursor-not-allowed'); }
        };

        window.openModal = () => { if(currentUser && currentUser.role === 'new') return showToast('Access Denied! Wait for Admin to assign role.', 'error'); document.getElementById('modal').classList.remove('hidden'); };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
        let currentLeadId = null;
        window.openStatusModal = (id, status) => { currentLeadId = id; document.getElementById('newStatus').value = status || 'Pending'; document.getElementById('statusModal').classList.remove('hidden'); };
        window.closeStatusModal = () => document.getElementById('statusModal').classList.add('hidden');
        window.saveStatus = async () => { await updateDoc(doc(db,'leads',currentLeadId), {status: document.getElementById('newStatus').value}); showToast('Status Updated!'); closeStatusModal(); };

        let targetSubDSAId = null; 
        function loadNewUsers(){
            onSnapshot(query(collection(db,'users'), where('role','==','dsa')), snap => {
                const sel = document.getElementById('modalDSASelect'); if(!sel) return; sel.innerHTML = '<option value="">-- Choose DSA --</option>';
                snap.forEach(d => { const u = d.data(); sel.innerHTML += `<option value="${u.email}">${u.name||u.email}</option>`; });
            });

            onSnapshot(collection(db,'users'), snap => {
                const userList = document.getElementById('userList'); userList.innerHTML = ''; window.allUsers = [];
                snap.forEach(d => {
                    const u = d.data(); u.id = d.id; window.allUsers.push(u); 
                    const userIdShort = `USR-${window.generate5DigitId(d.id)}`;
                    let rc = u.role === 'admin' ? 'bg-red-100 text-red-700' : u.role === 'dsa' ? 'bg-purple-100 text-purple-700' : u.role === 'subdsa' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600';
                    let act = '';
                    if(u.role !== 'admin') {
                        let md = u.role !== 'dsa' ? `<button onclick="setRole('${d.id}','dsa')" class='text-[9px] bg-green-50 text-green-700 px-2 py-1.5 rounded-lg border border-green-200 font-bold shadow-sm'>Make DSA</button>` : '';
                        let ms = `<button onclick="openSubDSAModal('${d.id}')" class='text-[9px] bg-blue-50 text-blue-700 px-2 py-1.5 rounded-lg border border-blue-200 ml-1 font-bold shadow-sm'>Make SubDSA</button>`;
                        let bl = currentUser.role === 'admin' ? `<button onclick="toggleBlock('${d.id}','${u.blocked?'yes':'no'}')" class='text-[9px] ${u.blocked ? 'bg-amber-500 text-white' : 'bg-amber-50 text-amber-700'} px-2 py-1.5 rounded-lg ml-1 border border-amber-200 font-bold shadow-sm'>${u.blocked ? 'Unblock' : 'Block'}</button>` : '';
                        let dl = currentUser.role === 'admin' ? `<button onclick="deleteUser('${d.id}')" class='text-[9px] bg-red-50 text-red-700 px-2 py-1.5 rounded-lg ml-1 border border-red-200 shadow-sm'><i class="fa-solid fa-trash"></i></button>` : '';
                        act = `<div class="flex flex-wrap gap-1 mt-2 pt-2 border-t border-slate-100">${md} ${ms} ${bl} ${dl}</div>`;
                    } else act = `<div class="text-[9px] text-slate-400 mt-2 pt-2 border-t border-slate-100 italic">Admin Access (Protected)</div>`;
                    
                    userList.innerHTML += `<div class='bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col gap-1.5 mb-2'><div class="flex justify-between items-start"><div class="w-full"><div class="font-bold text-sm text-slate-800">${window.escapeHTML(u.name)||'Unknown'} <span class="text-[9px] font-mono text-slate-400 font-medium ml-1 bg-slate-100 px-1 rounded">#${userIdShort}</span></div><div class="text-[10px] text-slate-500 font-medium mb-1">${window.escapeHTML(u.email)}</div></div><span class="text-[9px] uppercase font-black px-2 py-1 rounded-md ${rc}">${u.role||'new'}</span></div>${act}</div>`;
                });
                window.updateNotifications(); 
            });
        }

        window.openSubDSAModal = (id) => { targetSubDSAId = id; document.getElementById('subDSAModal').classList.remove('hidden'); }
        window.closeSubDSAModal = () => { targetSubDSAId = null; document.getElementById('subDSAModal').classList.add('hidden'); }
        window.confirmSubDSALink = async () => { const p = document.getElementById('modalDSASelect').value; if(!p) return showToast('Select DSA first', 'error'); if(targetSubDSAId) { await updateDoc(doc(db,'users',targetSubDSAId), {role:'subdsa', parentEmail:p}); showToast('Linked to DSA!'); closeSubDSAModal(); } }
        window.deleteUser = async(id) => { if(currentUser.role === 'admin' && confirm('Delete?')) { await deleteDoc(doc(db,'users',id)); showToast('Deleted'); } };
        window.toggleBlock = async(id, state) => { if(currentUser.role === 'admin') { await updateDoc(doc(db,'users',id), {blocked: (state !== 'yes')}); showToast('Block status updated'); } };
        window.setRole = async(id, role) => { await updateDoc(doc(db,'users',id), {role}); showToast('Role Updated'); };
        window.deleteLead = async(id) => { if(currentUser.role === 'admin' && confirm('Delete lead?')) { await deleteDoc(doc(db,'leads',id)); showToast('Lead Deleted'); } };

        window.createSubDSA = async () => {
            const m = document.getElementById('subMobile').value.trim();
            if(m.length !== 10) return showToast('10 digit mobile needed', 'error');
            const snap = await getDocs(query(collection(db,'users'), where('mobile','==',m)));
            if(snap.empty) return showToast('User not found with this mobile no.', 'error'); 
            const d = snap.docs[0];
            if(d.data().role !== 'new') return showToast('User already assigned a role', 'error');
            await updateDoc(doc(db,'users',d.id), {role:'subdsa', parentEmail:currentUser.email}); 
            showToast('SubDSA Successfully Linked!');
            document.getElementById('subMobile').value = '';
        };

        function loadMySubDSA(){
            onSnapshot(query(collection(db,'users'), where('parentEmail','==',currentUser.email)), snap => {
                const subList = document.getElementById('subList'); subList.innerHTML = ''; window.mySubDSAEmails = []; 
                snap.forEach(d => {
                    const u = d.data(); window.mySubDSAEmails.push(u.email); const shortId = `USR-${window.generate5DigitId(d.id)}`;
                    subList.innerHTML += `<div class='bg-blue-50/50 p-2.5 rounded-xl border border-blue-100 flex items-center gap-3 mb-2'><div class="bg-gradient-to-tr from-blue-500 to-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-xs shadow-sm"><i class="fa-solid fa-user"></i></div><div><div class="font-bold text-sm text-slate-800">${window.escapeHTML(u.name)} <span class="text-[9px] text-slate-400 font-normal">#${shortId}</span></div><div class="text-xs text-slate-500 font-medium">${window.escapeHTML(u.mobile)}</div></div></div>`;
                });
                renderLeadsUI(); 
            });
        }

        window.showPage = (p) => { document.getElementById('leadsPage').classList.toggle('hidden', p !== 'leads'); document.getElementById('usersPage').classList.toggle('hidden', p !== 'users'); const tLead = document.getElementById('tab-leads'); const tUser = document.getElementById('tab-users'); if(p === 'leads'){ tLead.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-indigo-600 shadow-sm"; tUser.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-indigo-600"; } else { tUser.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white text-indigo-600 shadow-sm"; tLead.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-indigo-600"; } };
        window.openCalcMenu = () => { document.getElementById('authBox').classList.add('hidden'); document.getElementById('app').classList.add('hidden'); document.body.classList.remove('modern-bg'); document.getElementById('calculatorPage').classList.add('hidden'); document.getElementById('calcMenuPage').classList.remove('hidden'); document.getElementById('calcMenuPage').classList.add('flex'); document.getElementById('roiReferencePage').classList.add('hidden'); document.getElementById('roiReferencePage').classList.remove('flex'); };
        window.closeCalcMenu = () => { document.getElementById('calcMenuPage').classList.add('hidden'); document.getElementById('calcMenuPage').classList.remove('flex'); if (currentUser) { document.getElementById('app').classList.remove('hidden'); } else { document.getElementById('authBox').classList.remove('hidden'); document.body.classList.add('modern-bg'); } };
        window.openCalculator = window.openCalcMenu; 

        // --- NEW: ROI Reference Functions ---
        window.showRoiReference = () => {
            document.getElementById('calcMenuPage').classList.add('hidden');
            document.getElementById('calcMenuPage').classList.remove('flex');
            document.getElementById('roiReferencePage').classList.remove('hidden');
            document.getElementById('roiReferencePage').classList.add('flex');
        };
        
        window.closeRoiReference = () => {
            document.getElementById('roiReferencePage').classList.add('hidden');
            document.getElementById('roiReferencePage').classList.remove('flex');
            document.getElementById('calcMenuPage').classList.remove('hidden');
            document.getElementById('calcMenuPage').classList.add('flex');
        };

        window.showCalcCategory = (cat) => {
            document.getElementById('calcMenuPage').classList.add('hidden'); document.getElementById('calculatorPage').classList.remove('hidden'); document.getElementById('calculatorPage').classList.add('flex'); document.getElementById('calcResultBox').classList.add('hidden');
            const selectMode = document.getElementById('calcMode'); selectMode.innerHTML = ''; 
            if (cat === 'loan') { document.getElementById('activeCalcTitle').innerText = 'Loan Calculator'; selectMode.innerHTML = `<option value="emi">Calculate EMI</option><option value="amount">Calculate Max Eligibility (Loan Amount)</option><option value="roi">Calculate ROI (%)</option><option value="term">Calculate Tenure (Term)</option>`; } 
            else if (cat === 'fd') { document.getElementById('activeCalcTitle').innerText = 'FD Calculator'; selectMode.innerHTML = `<option value="fd_mat">Calculate Maturity Value</option><option value="fd_prin">Calculate Principal (Reverse FD)</option>`; } 
            else if (cat === 'rd') { document.getElementById('activeCalcTitle').innerText = 'RD Calculator'; selectMode.innerHTML = `<option value="rd_mat">Calculate Maturity Value</option><option value="rd_dep">Calculate Monthly Deposit (Reverse RD)</option>`; }
            window.updateCalcUI();
        };

        window.goBackToCalcMenu = () => { document.getElementById('calculatorPage').classList.add('hidden'); document.getElementById('calculatorPage').classList.remove('flex'); document.getElementById('calcMenuPage').classList.remove('hidden'); document.getElementById('calcMenuPage').classList.add('flex'); };

        window.updateCalcUI = () => { 
            const mode = document.getElementById('calcMode').value; const amtLbl = document.getElementById('lblCalcAmount'); const emiLbl = document.getElementById('lblCalcEMI');
            document.getElementById('calcInputAmount').classList.remove('hidden'); document.getElementById('calcInputEMI').classList.remove('hidden'); document.getElementById('calcInputROI').classList.remove('hidden'); document.getElementById('calcInputTerm').classList.remove('hidden'); document.getElementById('calcResultBox').classList.add('hidden'); 

            if (mode === 'emi') { document.getElementById('calcInputEMI').classList.add('hidden'); amtLbl.innerText = "Loan Amount (â‚¹)"; }
            else if (mode === 'amount') { document.getElementById('calcInputAmount').classList.add('hidden'); emiLbl.innerText = "Monthly EMI (â‚¹)"; }
            else if (mode === 'roi' || mode === 'term') { amtLbl.innerText = "Loan Amount (â‚¹)"; emiLbl.innerText = "Monthly EMI (â‚¹)"; }
            else if (mode === 'fd_mat') { document.getElementById('calcInputEMI').classList.add('hidden'); amtLbl.innerText = "FD Investment Amount (â‚¹)"; }
            else if (mode === 'fd_prin') { document.getElementById('calcInputEMI').classList.add('hidden'); amtLbl.innerText = "Target Maturity Value (â‚¹)"; }
            else if (mode === 'rd_mat') { document.getElementById('calcInputAmount').classList.add('hidden'); emiLbl.innerText = "Monthly RD Deposit (â‚¹)"; }
            else if (mode === 'rd_dep') { document.getElementById('calcInputEMI').classList.add('hidden'); amtLbl.innerText = "Target Maturity Value (â‚¹)"; }
            
            document.getElementById('cAmount').value = ''; document.getElementById('cEmi').value = ''; document.getElementById('cRoi').value = ''; document.getElementById('cTerm').value = ''; 
        };
        
        window.performCalculation = () => { 
            const mode = document.getElementById('calcMode').value; 
            const pInput = parseFloat(document.getElementById('cAmount').value); const eInput = parseFloat(document.getElementById('cEmi').value); const rInput = parseFloat(document.getElementById('cRoi').value); const nRaw = parseFloat(document.getElementById('cTerm').value); 
            let nInput = nRaw; if(document.getElementById('cTermType').value === 'years') nInput = nRaw * 12;

            let p = pInput || 0, e = eInput || 0, r = rInput || 0, n = nInput || 0; 
            let resultMain = 0, totalPayment = 0, totalInterest = 0, finalP = 0; 
            
            try { 
                if (mode === 'emi') { 
                    if(!p || !r || !n) return showToast("Enter Loan Amount, ROI and Tenure.", "error"); 
                    let monthlyRate = r / 12 / 100; e = (p * monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1); 
                    resultMain = e; finalP = p; totalPayment = e * n; totalInterest = totalPayment - finalP;
                    document.getElementById('resMainTitle').innerText = "Monthly EMI"; document.getElementById('resLbl1').innerText="Principal Amount"; document.getElementById('resLbl2').innerText="Total Interest"; document.getElementById('resLbl3').innerText="Total Payment"; 
                } else if (mode === 'amount') { 
                    if(!e || !r || !n) return showToast("Enter EMI, ROI and Tenure.", "error"); 
                    let monthlyRate = r / 12 / 100; p = (e * (Math.pow(1 + monthlyRate, n) - 1)) / (monthlyRate * Math.pow(1 + monthlyRate, n)); 
                    resultMain = p; finalP = p; totalPayment = e * n; totalInterest = totalPayment - finalP;
                    document.getElementById('resMainTitle').innerText = "Max Eligibility"; document.getElementById('resLbl1').innerText="Principal Amount"; document.getElementById('resLbl2').innerText="Total Interest"; document.getElementById('resLbl3').innerText="Total Payment"; 
                } else if (mode === 'term') { 
                    if(!p || !e || !r) return showToast("Enter Amount, EMI and ROI.", "error"); 
                    let monthlyRate = r / 12 / 100; if (e <= p * monthlyRate) return showToast("EMI too low!", "error"); 
                    n = Math.log(e / (e - p * monthlyRate)) / Math.log(1 + monthlyRate); 
                    resultMain = Math.ceil(n); finalP = p; e = eInput; totalPayment = e * resultMain; totalInterest = totalPayment - finalP;
                    document.getElementById('resMainTitle').innerText = "Total Tenure"; document.getElementById('resMainValue').innerText = resultMain + " Months";
                    document.getElementById('resLbl1').innerText="Principal Amount"; document.getElementById('resLbl2').innerText="Total Interest"; document.getElementById('resLbl3').innerText="Total Payment"; 
                } else if (mode === 'roi') { 
                    if(!p || !e || !n) return showToast("Enter Amount, EMI and Tenure.", "error"); 
                    if(e * n <= p) return showToast("Invalid inputs.", "error"); 
                    let low = 0.000001, high = 100.0, mid = 0; 
                    while (high - low > 0.00001) { mid = (low + high) / 2; let mRate = mid / 12 / 100; let calcE = (p * mRate * Math.pow(1 + mRate, n)) / (Math.pow(1 + mRate, n) - 1); if (calcE > e) high = mid; else low = mid; } 
                    resultMain = mid; finalP = p; totalPayment = e * n; totalInterest = totalPayment - finalP;
                    document.getElementById('resMainTitle').innerText = "Rate of Interest"; document.getElementById('resMainValue').innerText = resultMain.toFixed(2) + "% p.a.";
                    document.getElementById('resLbl1').innerText="Principal Amount"; document.getElementById('resLbl2').innerText="Total Interest"; document.getElementById('resLbl3').innerText="Total Payment"; 
                } else if (mode === 'fd_mat') {
                    if(!p || !r || !n) return showToast("Enter Investment, ROI and Tenure.", "error");
                    let t = n / 12; let rate = r / 100;
                    let maturityAmount = p * Math.pow((1 + rate/4), 4 * t);
                    resultMain = maturityAmount; finalP = p; totalInterest = maturityAmount - p; totalPayment = p;
                    document.getElementById('resMainTitle').innerText = "Maturity Value (FD)"; document.getElementById('resLbl1').innerText="Total Invested"; document.getElementById('resLbl2').innerText="Interest Earned"; document.getElementById('resLbl3').innerText="Maturity Value"; 
                } else if (mode === 'fd_prin') {
                    if(!p || !r || !n) return showToast("Enter Target Maturity, ROI and Tenure.", "error");
                    let t = n / 12; let rate = r / 100;
                    let reqPrincipal = p / Math.pow((1 + rate/4), 4 * t);
                    resultMain = reqPrincipal; finalP = reqPrincipal; totalInterest = p - reqPrincipal; totalPayment = reqPrincipal;
                    document.getElementById('resMainTitle').innerText = "Deposit Needed"; document.getElementById('resLbl1').innerText="Target Maturity"; document.getElementById('resLbl2').innerText="Interest Component"; document.getElementById('resLbl3').innerText="Deposit Required"; 
                } else if (mode === 'rd_mat') {
                    if(!e || !r || !n) return showToast("Enter Monthly Deposit, ROI and Tenure.", "error");
                    let rate = r / 100; let totalInvested = e * n;
                    let totalInterestRd = e * (n * (n + 1)) / 2 * (rate / 12);
                    let maturityAmount = totalInvested + totalInterestRd;
                    resultMain = maturityAmount; finalP = totalInvested; totalInterest = totalInterestRd; totalPayment = totalInvested;
                    document.getElementById('resMainTitle').innerText = "Maturity Value (RD)"; document.getElementById('resLbl1').innerText="Total Invested"; document.getElementById('resLbl2').innerText="Interest Earned"; document.getElementById('resLbl3').innerText="Maturity Value"; 
                } else if (mode === 'rd_dep') {
                    if(!p || !r || !n) return showToast("Enter Target Maturity, ROI and Tenure.", "error");
                    let rate = r / 100; let multiplier = n + (n * (n + 1) / 2) * (rate / 12);
                    let reqMonthly = p / multiplier;
                    resultMain = reqMonthly; finalP = reqMonthly * n; totalInterest = p - finalP; totalPayment = finalP;
                    document.getElementById('resMainTitle').innerText = "Monthly Deposit Needed"; document.getElementById('resLbl1').innerText="Target Maturity"; document.getElementById('resLbl2').innerText="Interest Component"; document.getElementById('resLbl3').innerText="Total Deposited"; 
                }

                if(mode !== 'term' && mode !== 'roi') { document.getElementById('resMainValue').innerText = "â‚¹" + Math.round(resultMain).toLocaleString('en-IN'); }
                if(mode === 'fd_mat' || mode === 'rd_mat') {
                    document.getElementById('resPrincipal').innerText = "â‚¹" + Math.round(finalP).toLocaleString('en-IN'); 
                    document.getElementById('resInterest').innerText = "â‚¹" + Math.round(totalInterest > 0 ? totalInterest : 0).toLocaleString('en-IN'); 
                    document.getElementById('resTotal').innerText = "â‚¹" + Math.round(resultMain > 0 ? resultMain : 0).toLocaleString('en-IN'); 
                } else if(mode === 'fd_prin') {
                    document.getElementById('resPrincipal').innerText = "â‚¹" + Math.round(p).toLocaleString('en-IN'); 
                    document.getElementById('resInterest').innerText = "â‚¹" + Math.round(totalInterest > 0 ? totalInterest : 0).toLocaleString('en-IN'); 
                    document.getElementById('resTotal').innerText = "â‚¹" + Math.round(resultMain > 0 ? resultMain : 0).toLocaleString('en-IN'); 
                } else if(mode === 'rd_dep') {
                    document.getElementById('resPrincipal').innerText = "â‚¹" + Math.round(p).toLocaleString('en-IN'); 
                    document.getElementById('resInterest').innerText = "â‚¹" + Math.round(totalInterest > 0 ? totalInterest : 0).toLocaleString('en-IN'); 
                    document.getElementById('resTotal').innerText = "â‚¹" + Math.round(finalP > 0 ? finalP : 0).toLocaleString('en-IN'); 
                } else {
                    document.getElementById('resPrincipal').innerText = "â‚¹" + Math.round(finalP).toLocaleString('en-IN'); 
                    document.getElementById('resInterest').innerText = "â‚¹" + Math.round(totalInterest > 0 ? totalInterest : 0).toLocaleString('en-IN'); 
                    document.getElementById('resTotal').innerText = "â‚¹" + Math.round(totalPayment > 0 ? totalPayment : 0).toLocaleString('en-IN'); 
                }
                
                document.getElementById('calcResultBox').classList.remove('hidden'); 
            } catch (err) { showToast("Calculation Error", "error"); } 
        };
    </script>
</body>
</html>

