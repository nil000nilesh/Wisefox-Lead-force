<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wisefox LeadApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .input-field:focus { border-color: #4F46E5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex justify-center items-center">

    <div class="w-full max-w-md h-full sm:h-[90vh] sm:rounded-3xl bg-white shadow-2xl relative flex flex-col overflow-hidden">
        
        <div class="bg-indigo-600 text-white p-5 pt-8 shadow-md z-10 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-xl tracking-tight"><i class="fa-solid fa-fox mr-2"></i>Wisefox</h2>
                    <p class="text-xs text-indigo-200 opacity-90" id="userRoleDisplay">Lead Management System</p>
                </div>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                    <i class="fa-solid fa-power-off text-white"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-4 relative">

            <div id="authBox" class="h-full flex flex-col justify-center items-center fade-in">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600 text-2xl">
                        <i class="fa-solid fa-user-lock"></i>
                    </div>
                    <h3 id="authTitle" class="text-2xl font-bold text-slate-800">Welcome Back</h3>
                    <p id="authSubtitle" class="text-sm text-slate-500">Sign in to your account</p>
                </div>

                <div class="w-full max-w-xs space-y-3 mt-2">
                    <input id="emailInput" type="email" placeholder="Email Address" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <input id="passwordInput" type="password" placeholder="Password (Min 6 chars)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    
                    <button id="mainAuthBtn" onclick="handleEmailAuth()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-xl shadow-md transition mt-2">
                        Login
                    </button>

                    <div class="text-center text-sm text-slate-600 mt-3">
                        <span id="authToggleText">Don't have an account?</span>
                        <button onclick="toggleAuthMode()" class="text-indigo-600 font-bold ml-1 hover:underline">Sign Up</button>
                    </div>

                    <div class="flex items-center my-4">
                        <div class="flex-grow border-t border-slate-200"></div>
                        <span class="px-3 text-slate-400 text-xs font-medium">OR</span>
                        <div class="flex-grow border-t border-slate-200"></div>
                    </div>

                    <button onclick="googleLogin()" class="w-full bg-white border border-slate-300 text-slate-700 font-medium py-3 rounded-xl shadow-sm hover:bg-slate-50 hover:shadow-md transition flex items-center justify-center gap-3">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="G">
                        Continue with Google
                    </button>

                    <button onclick="openCalculator()" class="w-full bg-slate-800 text-white font-medium py-3 rounded-xl shadow-sm hover:bg-slate-900 transition flex items-center justify-center gap-3 mt-4">
                        <i class="fa-solid fa-calculator"></i> Financial Calculator
                    </button>
                </div>
            </div>

            <div id="calculatorPage" class="hidden h-full flex-col fade-in pb-10">
                <div class="flex items-center mb-6 border-b border-slate-200 pb-3">
                    <button onclick="closeCalculator()" class="text-slate-500 hover:text-indigo-600 transition mr-3">
                        <i class="fa-solid fa-arrow-left text-xl"></i>
                    </button>
                    <h3 class="text-xl font-bold text-slate-800">Advanced Calculator</h3>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">What do you want to calculate?</label>
                        <select id="calcMode" onchange="updateCalcUI()" class="w-full border border-slate-300 rounded-lg p-3 mt-1 bg-white focus:outline-none focus:border-indigo-500 font-medium text-indigo-700">
                            <option value="emi">Calculate EMI</option>
                            <option value="amount">Calculate Loan Amount</option>
                            <option value="roi">Calculate ROI (%)</option>
                            <option value="term">Calculate Tenure (Term)</option>
                        </select>
                    </div>

                    <div id="calcInputAmount" class="relative">
                        <label class="text-xs font-semibold text-slate-600">Loan Amount (₹)</label>
                        <input id="cAmount" type="number" placeholder="e.g. 500000" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 mt-1 focus:outline-none" />
                    </div>

                    <div id="calcInputEMI" class="relative hidden">
                        <label class="text-xs font-semibold text-slate-600">Monthly EMI (₹)</label>
                        <input id="cEmi" type="number" placeholder="e.g. 15000" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 mt-1 focus:outline-none" />
                    </div>

                    <div id="calcInputROI" class="relative">
                        <label class="text-xs font-semibold text-slate-600">Rate of Interest (% p.a.)</label>
                        <input id="cRoi" type="number" step="0.1" placeholder="e.g. 8.5" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 mt-1 focus:outline-none" />
                    </div>

                    <div id="calcInputTerm" class="relative">
                        <label class="text-xs font-semibold text-slate-600">Tenure (in Months)</label>
                        <input id="cTerm" type="number" placeholder="e.g. 60 (for 5 years)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 mt-1 focus:outline-none" />
                    </div>

                    <button onclick="performCalculation()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 transition">
                        Calculate Now
                    </button>

                    <div id="calcResultBox" class="hidden mt-6 bg-slate-800 text-white p-5 rounded-2xl shadow-xl">
                        <div class="text-center mb-4 border-b border-slate-600 pb-4">
                            <p class="text-sm text-emerald-400 font-semibold uppercase tracking-wider mb-1" id="resMainTitle">Your Monthly EMI</p>
                            <h2 class="text-3xl font-bold" id="resMainValue">₹0</h2>
                        </div>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Principal Amount</span>
                                <span class="font-semibold" id="resPrincipal">₹0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Interest Paid</span>
                                <span class="font-semibold text-red-400" id="resInterest">₹0</span>
                            </div>
                            <div class="flex justify-between border-t border-slate-600 pt-3">
                                <span class="text-slate-300 font-bold">Total Payment (Till Maturity)</span>
                                <span class="font-bold text-emerald-400" id="resTotal">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signupBox" class="hidden h-full flex flex-col justify-center fade-in">
                <h3 class="text-xl font-bold mb-1 text-slate-800">Complete Profile</h3>
                <p class="text-sm text-slate-500 mb-4">Please provide your details to continue.</p>
                <div class="space-y-4">
                    <input id="profileName" placeholder="Full Name" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <input id="mobile" type="number" placeholder="Mobile Number (10 digits)" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <input id="location" placeholder="Location / City" class="input-field w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none" />
                    <button onclick="completeSignup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3.5 rounded-xl shadow-lg mt-4 transition">
                        Save & Continue
                    </button>
                </div>
            </div>

            <div id="app" class="hidden pb-20 fade-in">
                
                <div class="bg-slate-200/50 p-1 rounded-xl flex mb-6 sticky top-0 backdrop-blur-md z-10 border border-slate-200">
                    <button onclick="showPage('leads')" id="tab-leads" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-white text-indigo-600 shadow-sm">Leads</button>
                    <button onclick="showPage('users')" id="tab-users" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 transition-all">Team</button>
                </div>

                <div id="leadsPage">
                    <button onclick="openModal()" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3 rounded-xl shadow-lg mb-5 font-medium flex items-center justify-center hover:shadow-xl transition">
                        <i class="fa-solid fa-plus-circle mr-2"></i> Generate New Lead
                    </button>
                    <div id="list" class="space-y-3 pb-10"></div>
                </div>

                <div id="usersPage" class="hidden space-y-6">
                    <div id="dsaPanel" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wide">Add Sub-DSA</h3>
                        <div class="space-y-3">
                            <input id="subEmail" placeholder="User Email" class="input-field w-full border border-slate-200 rounded-lg p-2.5 text-sm" />
                            <input id="subMobile" type="number" placeholder="User Mobile (10 digits)" class="input-field w-full border border-slate-200 rounded-lg p-2.5 text-sm" />
                            <button onclick="createSubDSA()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-medium">Link Sub-DSA</button>
                        </div>
                    </div>

                    <div id="mySubList" class="hidden">
                        <h3 class="font-bold text-slate-700 mb-2">My Team</h3>
                        <div id="subList" class="space-y-2"></div>
                    </div>

                    <div id="adminPanel" class="hidden">
                        <h3 class="font-bold text-slate-700 mb-3">All Users Directory</h3>
                        <div id="userList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">New Lead Details</h3>
            <div class="space-y-3">
                <input id="leadName" placeholder="Client Name" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                <input id="leadPhone" type="number" placeholder="Mobile No (10 Digits)" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                <textarea id="leadAddress" placeholder="Full Address / City" rows="2" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500"></textarea>
                <select id="type" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500">
                    <option>Personal Loan</option>
                    <option>Home Loan</option>
                    <option>Business Loan</option>
                    <option>Auto Loan</option>
                </select>
                <input id="leadAmount" placeholder="Amount Required" type="number" class="w-full border border-slate-300 p-2.5 rounded-lg bg-slate-50 focus:outline-none focus:border-indigo-500" />
                <div class="flex gap-2 mt-4 pt-2 border-t border-slate-100">
                    <button onclick="closeModal()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
                    <button onclick="saveLead()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg shadow hover:bg-indigo-700">Save Lead</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Update Status</h3>
            <select id="newStatus" class="w-full border p-3 rounded-lg mb-4 bg-slate-50 focus:outline-none">
                <option>Pending</option>
                <option>Contacted</option>
                <option>In Process</option>
                <option>Sanctioned</option>
                <option>Disbursed</option>
                <option>Rejected</option>
            </select>
            <div class="flex gap-2">
                <button onclick="closeStatusModal()" class="flex-1 text-slate-500">Cancel</button>
                <button onclick="saveStatus()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Update</button>
            </div>
        </div>
    </div>

    <div id="subDSAModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-slate-800">Assign Parent DSA</h3>
            <label class="text-xs font-bold text-slate-600 uppercase">Select DSA</label>
            <div class="relative mb-4 mt-2">
                <select id="modalDSASelect" class="w-full border border-slate-200 bg-slate-50 rounded-lg p-3 focus:outline-none font-medium text-slate-700">
                    <option value="">-- Choose DSA --</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="closeSubDSAModal()" class="flex-1 text-slate-500 py-2 hover:bg-slate-50 rounded-lg">Cancel</button>
                <button onclick="confirmSubDSALink()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg shadow">Link Now</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E",
            authDomain: "wisfox-lead-app.firebaseapp.com",
            projectId: "wisfox-lead-app"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const db = getFirestore(appFirebase);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        window.mySubDSAEmails = [];
        window.latestLeadsSnap = null;

        // --- CALCULATOR LOGIC START ---
        window.openCalculator = () => {
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('calculatorPage').classList.remove('hidden');
            document.getElementById('calculatorPage').classList.add('flex');
            document.getElementById('calcResultBox').classList.add('hidden');
        };

        window.closeCalculator = () => {
            document.getElementById('calculatorPage').classList.add('hidden');
            document.getElementById('calculatorPage').classList.remove('flex');
            document.getElementById('authBox').classList.remove('hidden');
        };

        window.updateCalcUI = () => {
            const mode = document.getElementById('calcMode').value;
            document.getElementById('calcInputAmount').classList.remove('hidden');
            document.getElementById('calcInputEMI').classList.remove('hidden');
            document.getElementById('calcInputROI').classList.remove('hidden');
            document.getElementById('calcInputTerm').classList.remove('hidden');
            document.getElementById('calcResultBox').classList.add('hidden');

            // Hide the input that we are trying to calculate
            if (mode === 'emi') document.getElementById('calcInputEMI').classList.add('hidden');
            if (mode === 'amount') document.getElementById('calcInputAmount').classList.add('hidden');
            if (mode === 'roi') document.getElementById('calcInputROI').classList.add('hidden');
            if (mode === 'term') document.getElementById('calcInputTerm').classList.add('hidden');
            
            // Clear fields
            document.getElementById('cAmount').value = '';
            document.getElementById('cEmi').value = '';
            document.getElementById('cRoi').value = '';
            document.getElementById('cTerm').value = '';
        };

        function formatCurrency(num) {
            return "₹" + Math.round(num).toLocaleString('en-IN');
        }

        window.performCalculation = () => {
            const mode = document.getElementById('calcMode').value;
            const pInput = parseFloat(document.getElementById('cAmount').value);
            const eInput = parseFloat(document.getElementById('cEmi').value);
            const rInput = parseFloat(document.getElementById('cRoi').value);
            const nInput = parseFloat(document.getElementById('cTerm').value);

            let p = pInput || 0, e = eInput || 0, r = rInput || 0, n = nInput || 0;
            let resultMain = 0, totalPayment = 0, totalInterest = 0, finalP = 0;
            
            try {
                if (mode === 'emi') {
                    if(!p || !r || !n) return alert("Please enter Loan Amount, ROI and Tenure.");
                    let monthlyRate = r / 12 / 100;
                    e = (p * monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
                    resultMain = e;
                    finalP = p;
                    document.getElementById('resMainTitle').innerText = "Monthly EMI";
                    document.getElementById('resMainValue').innerText = formatCurrency(resultMain);

                } else if (mode === 'amount') {
                    if(!e || !r || !n) return alert("Please enter EMI, ROI and Tenure.");
                    let monthlyRate = r / 12 / 100;
                    p = (e * (Math.pow(1 + monthlyRate, n) - 1)) / (monthlyRate * Math.pow(1 + monthlyRate, n));
                    resultMain = p;
                    finalP = p;
                    document.getElementById('resMainTitle').innerText = "Max Loan Eligibility";
                    document.getElementById('resMainValue').innerText = formatCurrency(resultMain);

                } else if (mode === 'term') {
                    if(!p || !e || !r) return alert("Please enter Loan Amount, EMI and ROI.");
                    let monthlyRate = r / 12 / 100;
                    if (e <= p * monthlyRate) return alert("EMI is too low to cover the monthly interest!");
                    n = Math.log(e / (e - p * monthlyRate)) / Math.log(1 + monthlyRate);
                    resultMain = Math.ceil(n);
                    finalP = p;
                    e = eInput; // Use actual inputted EMI for total calculations
                    document.getElementById('resMainTitle').innerText = "Total Tenure";
                    document.getElementById('resMainValue').innerText = resultMain + " Months";
                    n = resultMain; // use rounded months for totals

                } else if (mode === 'roi') {
                    if(!p || !e || !n) return alert("Please enter Loan Amount, EMI and Tenure.");
                    if(e * n <= p) return alert("Total payment (EMI * Term) must be greater than Loan Amount.");
                    
                    // Binary search to find ROI
                    let low = 0.000001, high = 100.0, mid = 0;
                    while (high - low > 0.00001) {
                        mid = (low + high) / 2;
                        let mRate = mid / 12 / 100;
                        let calcE = (p * mRate * Math.pow(1 + mRate, n)) / (Math.pow(1 + mRate, n) - 1);
                        if (calcE > e) high = mid; else low = mid;
                    }
                    resultMain = mid;
                    finalP = p;
                    document.getElementById('resMainTitle').innerText = "Rate of Interest";
                    document.getElementById('resMainValue').innerText = resultMain.toFixed(2) + "% p.a.";
                }

                // Summary Calculations
                if (mode !== 'roi' && mode !== 'term') {
                    totalPayment = e * n;
                    totalInterest = totalPayment - finalP;
                } else {
                    totalPayment = e * n;
                    totalInterest = totalPayment - finalP;
                }

                document.getElementById('resPrincipal').innerText = formatCurrency(finalP);
                document.getElementById('resInterest').innerText = formatCurrency(totalInterest > 0 ? totalInterest : 0);
                document.getElementById('resTotal').innerText = formatCurrency(totalPayment > 0 ? totalPayment : 0);
                
                document.getElementById('calcResultBox').classList.remove('hidden');

            } catch (err) {
                alert("Calculation Error. Please check your inputs.");
            }
        };
        // --- CALCULATOR LOGIC END ---


        // --- AUTH LOGIC START ---
        let isLoginMode = true;

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? 'Welcome Back' : 'Create Account';
            document.getElementById('authSubtitle').innerText = isLoginMode ? 'Sign in to your account' : 'Sign up to get started';
            document.getElementById('mainAuthBtn').innerText = isLoginMode ? 'Login' : 'Sign Up';
            document.getElementById('authToggleText').innerText = isLoginMode ? "Don't have an account?" : "Already have an account?";
            event.target.innerText = isLoginMode ? 'Sign Up' : 'Login';
        };

        window.handleEmailAuth = async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            if(!email || !password) return alert("Please enter both Email and Password!");
            if(password.length < 6) return alert("Password must be at least 6 characters long!");
            try {
                let result = isLoginMode 
                    ? await signInWithEmailAndPassword(auth, email, password)
                    : await createUserWithEmailAndPassword(auth, email, password);
                await handleLogin(result.user);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') alert("This email is already registered. Please Login instead.");
                else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') alert("Incorrect Email or Password!");
                else alert("Authentication Failed: " + error.message);
            }
        };

        window.googleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                await handleLogin(result.user);
            } catch (error) { 
                try { await signInWithRedirect(auth, provider); } 
                catch (err) { alert("Login failed. Please try Email/Password login."); }
            }
        };

        async function handleLogin(user){
            const snap = await getDocs(query(collection(db, "users"), where("email","==",user.email)));
            if(snap.empty){
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('signupBox').classList.remove('hidden');
                if(user.displayName) document.getElementById('profileName').value = user.displayName;
                window.tempUser = user; 
                return;
            }
            currentUser = snap.docs[0].data();
            currentUser.id = snap.docs[0].id; 
            startApp();
        }

        window.completeSignup = async () => {
            const user = window.tempUser;
            const nameVal = document.getElementById('profileName').value.trim() || user.displayName || 'User';
            const mobileVal = document.getElementById('mobile').value.trim();
            const locationVal = document.getElementById('location').value.trim();
            
            if(!nameVal || !mobileVal || !locationVal) return alert('Enter full details to continue!');
            if(mobileVal.length !== 10) return alert('Mobile number must be exactly 10 digits!');

            const role = user.email === 'nil000nilesh@gmail.com' ? 'admin' : 'new';
            const q = query(collection(db, "users"), where("email", "==", user.email));
            const snap = await getDocs(q);
            
            if(!snap.empty){
                const existingId = snap.docs[0].id;
                await updateDoc(doc(db,'users',existingId), { name: nameVal, mobile: mobileVal, location: locationVal });
                currentUser = snap.docs[0].data();
                currentUser.id = existingId;
            } else {
                await setDoc(doc(db,'users',user.uid), {
                    name: nameVal, email: user.email, mobile: mobileVal, location: locationVal, role, parentEmail: null
                });
                currentUser = {name: nameVal, email: user.email, role, mobile: mobileVal, location: locationVal};
            }
            document.getElementById('signupBox').classList.add('hidden');
            startApp();
        };

        function startApp(){
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = `Role: ${currentUser.role.toUpperCase()}`;
            loadLeads();
            
            if(currentUser.role === 'admin'){
                document.getElementById('adminPanel').classList.remove('hidden');
                loadNewUsers();
            }
            if(currentUser.role === 'dsa'){
                document.getElementById('dsaPanel').classList.remove('hidden');
                document.getElementById('mySubList').classList.remove('hidden');
                loadMySubDSA();
            }
        }

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- UI & TAB SWITCHING ---
        window.showPage = (p) => {
            document.getElementById('leadsPage').classList.toggle('hidden', p !== 'leads');
            document.getElementById('usersPage').classList.toggle('hidden', p !== 'users');
            const tLead = document.getElementById('tab-leads');
            const tUser = document.getElementById('tab-users');
            if(p === 'leads'){
                tLead.className = "flex-1 py-2 rounded-lg text-sm font-medium bg-white text-indigo-600 shadow-sm";
                tUser.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600";
            } else {
                tUser.className = "flex-1 py-2 rounded-lg text-sm font-medium bg-white text-indigo-600 shadow-sm";
                tLead.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600";
            }
        };

        function getStatusColor(status) {
            switch(status) {
                case 'Disbursed': return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                case 'Sanctioned': return 'bg-green-100 text-green-700 border-green-200';
                case 'Rejected': return 'bg-red-100 text-red-700 border-red-200';
                case 'In Process': return 'bg-blue-100 text-blue-700 border-blue-200';
                default: return 'bg-yellow-100 text-yellow-700 border-yellow-200';
            }
        }

        function renderLeads() {
            if (!window.latestLeadsSnap) return;
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            window.latestLeadsSnap.forEach(d => {
                const l = d.data();
                let canView = false;
                if (currentUser.role === 'admin') canView = true;
                else if (l.agentEmail === currentUser.email) canView = true;
                else if (currentUser.role === 'dsa' && window.mySubDSAEmails.includes(l.agentEmail)) canView = true;
                
                if (!canView) return;

                const statusClass = getStatusColor(l.status||'Pending');
                let btn = '';
                if(currentUser.role === 'dsa' || currentUser.role === 'admin'){
                    btn = `<button onclick="openStatusModal('${d.id}','${l.status||'Pending'}')" class='text-xs font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded'>Edit Status</button>`;
                }
                let adminBtns = '';
                if(currentUser.role === 'admin'){
                    adminBtns = `<button onclick="deleteLead('${d.id}')" class='text-xs text-red-500 bg-red-50 px-2 py-1 rounded ml-2'><i class="fa-solid fa-trash"></i></button>`;
                }

                list.innerHTML += `
                <div class='bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative mb-3'>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">${l.name}</h4>
                            <span class="text-xs font-semibold text-slate-500">${l.type}</span>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full font-bold border ${statusClass}">${l.status||'Pending'}</span>
                    </div>
                    
                    <div class="mb-3 mt-1 space-y-1 bg-slate-50 p-2 rounded-lg border border-slate-100">
                         <div class="text-sm text-slate-600"><i class="fa-solid fa-phone text-slate-400 mr-2 w-4"></i> ${l.phone}</div>
                         <div class="text-sm text-slate-600"><i class="fa-solid fa-location-dot text-slate-400 mr-2 w-4"></i> ${l.address || 'NA'}</div>
                    </div>

                    <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-100">
                        <div>
                            <div class="text-sm font-bold text-slate-800">₹${Number(l.amount).toLocaleString('en-IN')}</div>
                            <div class="text-[10px] text-indigo-700 font-bold bg-indigo-100 px-2 py-1 rounded mt-1 inline-block"><i class="fa-regular fa-user mr-1"></i> By: ${l.agentName || 'Unknown'}</div>
                        </div>
                        <div class="flex items-center">${btn} ${adminBtns}</div>
                    </div>
                </div>`;
            });
        }

        function loadLeads(){
            onSnapshot(collection(db,'leads'), snap => { window.latestLeadsSnap = snap; renderLeads(); });
        }

        window.saveLead = async () => {
            const name = document.getElementById('leadName').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const address = document.getElementById('leadAddress').value.trim();
            const amount = document.getElementById('leadAmount').value.trim();
            const type = document.getElementById('type').value;

            if(!name || !phone || !amount || !address) return alert('Please fill all fields including Address!');
            if(phone.length !== 10) return alert('Mobile number must be exactly 10 digits!');
            
            const userSnap = await getDocs(query(collection(db,'users'), where('email','==',currentUser.email)));
            if(!userSnap.empty && userSnap.docs[0].data().blocked) return alert('Blocked by Admin');

            await addDoc(collection(db,'leads'), {
                name, phone, address, type, amount: Number(amount)||0, status: 'Pending', 
                agentEmail: currentUser.email, agentName: currentUser.name || 'Unknown', created: new Date()
            });
            closeModal();
            document.getElementById('leadName').value=''; document.getElementById('leadPhone').value='';
            document.getElementById('leadAddress').value=''; document.getElementById('leadAmount').value='';
        };

        window.openModal = () => document.getElementById('modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        let currentLeadId = null;
        window.openStatusModal = (id, status) => { currentLeadId = id; document.getElementById('newStatus').value = status || 'Pending'; document.getElementById('statusModal').classList.remove('hidden'); };
        window.closeStatusModal = () => document.getElementById('statusModal').classList.add('hidden');
        window.saveStatus = async () => { await updateDoc(doc(db,'leads',currentLeadId), {status: document.getElementById('newStatus').value}); closeStatusModal(); };

        // --- ADMIN USERS ---
        let targetSubDSAId = null; 
        function loadNewUsers(){
            const dsaQuery = query(collection(db,'users'), where('role','==','dsa'));
            onSnapshot(dsaQuery, snap => {
                const sel = document.getElementById('modalDSASelect');
                if(!sel) return;
                sel.innerHTML = '<option value="">-- Choose DSA --</option>';
                snap.forEach(d => { const u = d.data(); sel.innerHTML += `<option value="${u.email}">${u.name||u.email}</option>`; });
            });

            onSnapshot(collection(db,'users'), snap => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    let roleBadgeColor = 'bg-gray-100 text-gray-600';
                    if(u.role === 'admin') roleBadgeColor = 'bg-red-100 text-red-700';
                    if(u.role === 'dsa') roleBadgeColor = 'bg-purple-100 text-purple-700';
                    if(u.role === 'subdsa') roleBadgeColor = 'bg-blue-100 text-blue-700';

                    let actionButtons = '';
                    if(u.role !== 'admin') {
                        let makeDSABtn = '';
                        if(u.role !== 'dsa') makeDSABtn = `<button onclick="setRole('${d.id}','dsa')" class='text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200'>Make DSA</button>`;
                        const makeSubDSABtn = `<button onclick="openSubDSAModal('${d.id}')" class='text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200 ml-1'>Make SubDSA</button>`;

                        let blockBtn = ''; let deleteUserBtn = '';
                        if(currentUser.role === 'admin'){
                            blockBtn = `<button onclick="toggleBlock('${d.id}','${u.blocked?'yes':'no'}')" class='text-[10px] ${u.blocked ? 'bg-amber-500 text-white' : 'bg-amber-50 text-amber-700'} px-2 py-1 rounded ml-1 border border-amber-200'>${u.blocked ? 'Unblock' : 'Block'}</button>`;
                            deleteUserBtn = `<button onclick="deleteUser('${d.id}')" class='text-[10px] bg-red-50 text-red-700 px-2 py-1 rounded ml-1 border border-red-200'><i class="fa-solid fa-trash"></i></button>`;
                        }
                        actionButtons = `<div class="flex flex-wrap gap-1 mt-1 pt-2 border-t border-slate-50">${makeDSABtn} ${makeSubDSABtn} ${blockBtn} ${deleteUserBtn}</div>`;
                    } else {
                         actionButtons = `<div class="text-[10px] text-slate-400 mt-1 pt-2 border-t border-slate-50 italic">Admin Access (Protected)</div>`;
                    }

                    userList.innerHTML += `
                    <div class='bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-2'>
                        <div class="flex justify-between items-start">
                            <div class="w-full">
                                <div class="font-bold text-sm text-slate-800">${u.name||'Unknown'}</div>
                                <div class="text-xs text-slate-500 mb-1">${u.email}</div>
                                <div class="text-[10px] text-slate-500 bg-slate-50 p-1.5 rounded-md flex items-center gap-2">
                                    <span><i class="fa-solid fa-phone text-slate-400 mr-1"></i>${u.mobile || 'NA'}</span><span class="text-slate-300">|</span><span><i class="fa-solid fa-map-pin text-slate-400 mr-1"></i>${u.location || 'NA'}</span>
                                </div>
                            </div>
                            <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${roleBadgeColor} whitespace-nowrap ml-2">${u.role||'new'}</span>
                        </div>
                        ${actionButtons}
                    </div>`;
                });
            });
        }

        window.openSubDSAModal = (id) => { targetSubDSAId = id; document.getElementById('subDSAModal').classList.remove('hidden'); }
        window.closeSubDSAModal = () => { targetSubDSAId = null; document.getElementById('subDSAModal').classList.add('hidden'); }

        window.confirmSubDSALink = async () => {
            const parentEmail = document.getElementById('modalDSASelect').value;
            if(!parentEmail) return alert('Please select a DSA first');
            if(targetSubDSAId) {
                await updateDoc(doc(db,'users',targetSubDSAId), {role:'subdsa', parentEmail:parentEmail});
                alert('User linked to DSA successfully');
                closeSubDSAModal();
            }
        }

        window.deleteUser = async(id) => { if(currentUser.role === 'admin' && confirm('Delete this user?')) await deleteDoc(doc(db,'users',id)); };
        window.toggleBlock = async(id, state) => { if(currentUser.role === 'admin') await updateDoc(doc(db,'users',id), {blocked: (state !== 'yes')}); };
        window.setRole = async(id, role) => updateDoc(doc(db,'users',id), {role});
        window.deleteLead = async(id) => { if(currentUser.role === 'admin' && confirm('Delete this lead?')) await deleteDoc(doc(db,'leads',id)); };

        window.createSubDSA = async () => {
            const email = document.getElementById('subEmail').value.trim();
            const mobile = document.getElementById('subMobile').value.trim();
            if(mobile.length !== 10) return alert('Sub-DSA Mobile number must be 10 digits!');
            const snap = await getDocs(query(collection(db,'users'), where('email','==',email)));
            if(snap.empty) return alert('User not found');
            const docSnap = snap.docs[0];
            if(docSnap.data().role !== 'new') return alert('User already assigned');
            await updateDoc(doc(db,'users',docSnap.id), {role:'subdsa', parentEmail:currentUser.email});
            alert('SubDSA added');
        };

        function loadMySubDSA(){
            const q = query(collection(db,'users'), where('parentEmail','==',currentUser.email));
            onSnapshot(q, snap => {
                const subList = document.getElementById('subList');
                subList.innerHTML = '';
                window.mySubDSAEmails = []; 
                snap.forEach(d => {
                    const u = d.data();
                    window.mySubDSAEmails.push(u.email); 
                    subList.innerHTML += `
                    <div class='bg-blue-50/50 p-3 rounded-lg border border-blue-100 flex items-center gap-3'>
                        <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></div>
                        <div><div class="font-bold text-sm text-slate-700">${u.name}</div><div class="text-xs text-slate-500">${u.mobile}</div></div>
                    </div>`;
                });
                renderLeads(); 
            });
        }
    </script>
</body>
</html>
